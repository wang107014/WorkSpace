#体检结算

	DHCPEPreAuditPay.js中的BBilled_click方法中

##预结算
	w ##class(web.DHCPE.Cashier).Cashier("")

###预结算过程可能的错误

	1、ADM表体检状态(PIADM_Status)：ARRIVED(达到)和REGISTERED(登记)有效,其他状态无效
	2、项目表项目状态(PIOI_ItemStat)：1(核实状态)有效,6(停止状态)无效
	3、套餐表项目状态(PIOE_ItemStat)：1(核实状态)有效,6(停止状态)无效
	4、加项医嘱未确认时会结算失败：CRMO=$o(^DHCPECRMO(0,"CRMORI","12345||12",0)),当CRMO为空时失败
	5、存在分类金额和项目金额不符的项目：当(a/b)*c-d>0.03时失败无效
		套餐费用表中的项目销售金额(PIOEF_FactAmount)--a、套餐表中的应收金额(PIOE_AccountAmount)--b、项目表中的应收金额(PIOI_AccountAmount)--c、项目费用表的项目销售金额(PIOIF_FactAmount)--d
	6、发票打印的最大明细数为空时失败无效：$g(^DHCPESetting("DHCPE","InvMaxListCount"))
	7、传入发票号不正确,请刷新后重试：获取后台发票号##class(web.DHCPE.DHCPEPAY).getcurinvno(userId)
	8、默认发票打印的项目设置不正确：$g(^DHCPESetting("DHCPE", "InvDefaulltFee"))
	9、传入的发票号信息不正确：前端传入发票号为空、获取后台发票号为空失败无效
	10、没有找到登记信息：传入参数的体检类型(个人或团体)和人员表id为空时失败无效
	11、没有找到对应的Adm号：$p($g(^DHCPEIADM(pAdmId)),"^",1)、$p($g(^DHCPEGADM(pAdmId)),"^",3)为空时失败无效
	12、获取审核合计金额,合计金额为0，不能结算：$p($g(^DHCPEPreA("27242")),"^",9)
	13、获取的审核合计金额不等于前端传入的应付金额则失败无效
	14、检测审核记录是否有记录已经结算：s haspayed=##class(web.DHCPE.Cashier).CheckAuditsPayed("27242")、haspayed不等于0时失败无效
	15、插入体检医嘱失败
	16、更新四舍五入金额错误
	17、发票没有对应的帐单
	18、传入的审核ID有空
	19、没有找到审核信息
	20、更新审核表状态失败：&SQL(Update DHC_PE_PreAudit set PA_ChargedStatus='CHARGED' where PA_RowId=:preAuditId)
	21、生成对照记录失败：&SQL(Insert into DHC_PE_PAPBRelate(PAPB_PA_DR,PAPB_PB_DR,PAPB_PBType,PAPB_UpdateUser_DR,PAPB_UpdateDate,PAPB_UpdateTime) values (:preAuditId,:BillId,'N',:userId,:curDate,:curTime)			)

###表结构

	w ##Class(web.DHCPE.DHCPEPAY).paybill(BillNo, UserID, LocID, PayModeStr, DepositStr, 0, PayAmount)
	1、收费业务表AR_Receipts中新增一条数据：&sql(insert into AR_Receipts values :PLIST())
	2、收费业务表AR_RcptPayMode中新增一条数据：&sql(insert into AR_RcptPayMode values :PLIST())
	3、收费业务表AR_RcptAlloc中新增一条数据：&sql(insert into AR_RcptAlloc values :PLIST())
	4、修改账单主表DHC_PatientBill
	



##真正结算

	w ##class(web.DHCPE.Cashier).RealCashier(1365,4647,"001544^^0^^")

###真正结算是可能出现的错误

	1、传入发票号不正确：##class(web.DHCPE.DHCPEPAY).getcurinvno(userId)
	2、不是预结算发票或者不是本人的预结算发票，不能处理



###表结构

	1、更新审核表中的收费状态：&SQL(Update DHC_PE_PreAudit set PA_ChargedStatus=:chargedStatus where PA_RowId=:preAuditId)
	2、
