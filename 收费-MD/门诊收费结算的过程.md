DHC_SOPFConfig#<font color=red>收费结算的流程</font>



##一、预交算的流程

	w ##class(web.DHCOPINVCons).OPBillCharge()

		/// Description: 记录结算医嘱数据及参数信息到进程Global
		/// Input: PaadmStr:结算就诊串,UserID:结算用户,UnBillOrdStr:不参与结算医嘱串,InsType,结算费别;PatPaySum,前台金额;ExpStr
		1、do ##class(web.DHCOPBillChargExcepitonAnalyse).SaveChargeOrdLog(Paadminfo,Userid,UnBillOrdStr,Instype,PatPaySum,ExpStr)
			1.1、通过门诊收费结算query获取需结算医嘱 
				d ##class(%ResultSet).RunQuery("web.DHCOPAdmFind","GetADMOrder","3953","1","^3547||5^3547||7^","4","120")
					1.1.1、循环取出医嘱：
						将急诊转出到住院的医嘱退出：q:$d(^DHCOPIPADMCON("OPADMORDER","OPAdm",PAADMRowid,OPOEOrdRowID))'=0
						留观医嘱推出：q:($p($g(^OEORD(+OrderRowid,"I",itemsub,"DHC")),"^",17)=1)
						将自备药品退出:q:($p(^OECPR(PriorityId),"^",1)["OM")
						已结算的医嘱退出：q:($p($g(^OEORD(OrderRowid,"I",itemsub,3)),"^",5)="P")!($p($g(^OEORD(OrderRowid,"I",itemsub,3)),"^",5)="I")
						未核实和执行的医嘱为退出：Q:((statcode'="V")&(statcode'="E"))
						医嘱费别不一样退出：Quit:((AdmInsType'="")&(AdmInsType'=InsTypeDR))
						价格为0的医嘱去掉：
						不能办理结算的医嘱：w ##class(web.UDHCOEORDOPIF).ReadSkinRtnFlag("29||1")
					1.1.2、收费前生成处方号：do ##class(web.DHCBillInterface).SetPresno(Paadminfo,Userid)
					
							
			


##过程

1、通过门诊收费结算query获取需结算医嘱

	d ##class(%ResultSet).RunQuery("web.DHCOPAdmFind","GetADMOrder",1133,2,"^^",6,231)


2、判断就诊记录是否存在预结算状态的发票记录,如果存在,则需先撤销后再结算(收费异常)

	w ##class(web.DHCOPBillChargExcepiton).CheckTPFlagByEpisodeID("","")
	
	为什么会有收费异常？
	1、因为就诊记录存在预结算状态(TP)的发票记录且没有打印发票

	如何根据就诊id来判断，就诊记录是否存在预结算状态(TP)的发票记录？
	1、根据票据账单连接表：DHC_BillConINV中的就诊id来查询获取到收据信息主表Dhc_invprt中的Rowid
	2、根据收据信息主表Dhc_invprt的Rowid来获取记录中结算状态。



	