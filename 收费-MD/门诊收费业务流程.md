#<font color=red>一、门诊收费业务流程</font>

##收费结算


###一、点击结算按钮js需要进行的操作来获取结算参数信息

	点击结算按钮时在udhcOPCharge.js中调用Bill_Click方法：

		1、 点击结算按钮确认是否结算
		2、 修改费别结算：判断是否该费别是否有医保
		3、 结算按钮置灰，不能再次点击使用
		4、 保存医嘱信息，保存成功则继续下去，否则把结算按钮恢复，使其可以重新使用，并结束此次结算。
		5、 获取用户session,安全组session,科室session
		6、 检查费用总额，支付方式，就诊列表获取就诊列表的就诊id
		7、 获取当前科室金额，也是需要结算的医嘱费用
		8、 获取选择需要结算的就诊id信息
		9、 获取支付方式信息
		10、获取不需要结算的医嘱id信息
	
		可能出现的报错的提示
			1、 NoOrdFoot：没结算的医嘱
			2、 支付方式为空
			3、 NotApproved：医嘱需要审批才能按照当前收费类别结算,当前结算操作已取消
			4、 InstypeChanged：医嘱收费类别发生了改变,请单击[确定]后重新结算
			5、 NoChangeOrdInstypeCLS：缺少元素[ChangeOrdInstypeCLS]
			6、 请输入实付金额
			7、 ActualMoneyError：实收金额小于应付金额.
			8、 HisCancleFailed：医保取消结算成功,但HIS系统取消结算失败,请和计算机室联系解决
			9、 多种支付方式结算失败
			10、 优惠券信息保存失败
			11、 第三方支付接口结算失败


###二、门诊收费预结算过程

	预结算时调用的类方法：w ##class(web.DHCOPINVCons).OPBillCharge()

	1、记录结算医嘱数据及参数信息到进程Global  
		1.1、循环取出需结算医嘱信息：
			1.1.1、将急诊转出到住院的医嘱退出  
			1.1.2、留观医嘱退出  
			1.1.3、将自备药品退出  
			1.1.4、如果医嘱未核实或已收费的则为退出  
			1.1.5、不是核实和执行的医嘱则退出  
			1.1.7、医嘱费别不一样退出
			1.1.6、价格为0的医嘱则退出   
		1.2、保存数据到进程Global：医嘱项^库存项^医嘱状态^医嘱账单状态^医嘱费别^接收科室^数量^单价^单位^金额^打包数量  、结算费别^结算就诊^总费用^扩展串

	2、判断就诊记录是否存在预结算状态的发票记录,如果存在,则需先撤销后再结算
		2.1、根据就诊id循环发票关联表,找出就诊id对应的每一条发票记录。
		2.2、查找循环出来的每一条发票记录中的结算状态(PRT_Flag)是否是预结算状态(TP)。
		2.3、如果其中有一条记录中存在有预结算的记录,则需要先到门诊收费异常处理的地方撤销异常后再去结算。


	3、根据就诊id更新医嘱子表的结算状态
		3.1、根据就诊RowID取病人的留观状态
		3.2、如果病人是留观病人且已留观出院并且未做过财务结算时，去掉该次就诊的id
		3.3、根据就诊id把医嘱子表的结算状态(TB)需账单改为已账单(B)。
	


	4、在账单表及相关表中新增记录信息
		4.1、在账单表(DHC_PatientBill)中新增一条记录信息
		4.2、在病人医嘱费用明细表(DHC_PatBillOrder)中新增记录,结算几条医嘱新增几条记录
		4.3、在账单收费项目明细表(DHC_PatBillDetails)中新增记录数据,结算的医嘱有几条收费项目明细就新增几条记录

	5、在发票表及相关表中新增记录信息
		5.1、在发票表(DHC_INVPRT)中新增一条记录
		5.2、在发票表的支付方式表(DHC_INVPayMode)中新增记录信息，有几种支付方式就新增几条记录信息
		5.3、在发票表与帐单表的关联表(DHC_BillConINV)中新增记录信息
		5.4、在门诊计费药房中间表(DHC_PHARWIN)中新增一条记录

	6、预结算过程中记录的一些临时进程global
		6.1记录结算医嘱数据：
			^||TMPDHCOPBILL("Charge",$j,"OrderItem")
		6.2记录账单医嘱信息：
			^TMP1("OPOrdITEM",$j,instypenot,PBOrderRowid)   
			^TMP1("OPOrdPresNo",$j,myinstype,myPresNo,myPBordrid)
		6.3、记录票据结算数据
			^TMP1("BillINV",$j,CBIinvidx,"RecInvCount")
			^TMP1("BillINV",$j,rbInvIdx,"INT",rbinstype,"BR",rbarcpbstr)
		6.4、记录接收科室、处方号
			^TMP1("Bill",$j)
			^TMP1("Loc",$j)
			^TMP1("Pres"$j)
		6.5、记录结算后医嘱数据信息到进程Global
			^||TMPDHCOPBILL("Charge",$j,"OrderItem",AdmDR,OrdItem,"ReBillLog")

	7、可能出现的报错
			100     账单不存在
			101		门诊结算没有数据(或账单已结算)
			102		主要是判断收钱，界面显示与后台计算如果大于1分退出
			103     门诊收费重新生成账单错误
			104     门诊收费的基本配置没有数据
			105     门诊收费支付方式输入为空
			106		门诊卡支付中?数据验证错误?请重新刷卡
			107     门诊收费院内账户不存在
			109     门诊收费员没有可用票据
			112     分币误差大于0.2,门诊收费四舍五入舍入金额过大
			113     门诊收费院内账户与患者身份不符
			114     医嘱被执行，不能结算
			120     门诊收费有异常收费记录需要处理
			123     门诊收费欠费结算异常
			125     预交金结算时账户余额不足
			129     门诊收费减材料库存失败
			130     门诊收费挂号费与处方不能一起结算
			131     门诊收费患者结算需要附加条件
			132     处方是否被拆分了，被拆分不能结算
			200     更新表中的状态错误


###三、门诊收费确认完成过程

	确认完成时调用的类方法：w ##class(web.DHCBillCons12).CompleteCharge()

	1、确认完成时可能出现的错误
		133:账单金额不一致(账单表(DHC_PatientBill)中的金额和病人医嘱费用明细表(DHC_PatBillOrder)中的金额不一致)
		134:账单跟发票金额不一致(账单表(DHC_PatientBill)中的金额和发票表中(DHC_INVPRT)的金额不一致)


	2、在相关表中修改记录信息
		2.1、更新账单表(DHC_PatientBill)中的计费状态(PB_PayedFlag),由账单(B)改为计费(P)
		2.2、更新发票表(DHC_INVPRT)中的结算状态(PRT_Flag),由预结算(TP)改为正常(N)
		2.3、更新门诊计费药房中间表(DHC_PHARWIN)中的收费转态(PHA_RETFLAG),由空改为收费成功(1)
		2.4、如果是挂号结算,则更新挂号表(DHCRegistrationFee)中的发票id(Regfeetemp1),由空改为发票表(DHC_INVPRT)中的id
		2.5、把医嘱子表(OE_OrdItem)中的结算状态(OEORI_Billed),由已账单(B)改为已收费(P)



###三、相关表中新增数据

1、在账单表(DHC_PatientBill)中新增一条记录信息

	w ##class(web.DHCOPINVCons).OPBillCharge
	w ##class(web.UDHCJFBILL).BILL(PAADMRowid,Userid)
	w ##class(web.UDHCJFBILL).BILLC()
	w ##class(web.UDHCJFBILL).PBORD()
	w ##class(UDHCJFPB).PBINS()
	w ##class(UDHCJFPB).INSERT()
	&sql(INSERT INTO DHC_PatientBill Values PLIST())
	

2、在病人医嘱费用明细表(DHC_PatBillOrder)中新增记录

	w ##class(web.DHCOPINVCons).OPBillCharge
	w ##class(web.UDHCJFBILL).BILL(PAADMRowid,Userid)
	w ##class(web.UDHCJFBILL).PBORD()
	w ##class(web.UDHCJFBILL).PBOINS()
	w ##class(UDHCJFPBO).INSERT()
	&sql(INSERT INTO DHC_PatBillOrder Values PLIST())

3、在账单收费项目明细表(DHC_PatBillDetails)中新增记录数据

	w ##class(web.DHCOPINVCons).OPBillCharge()
	w ##class(web.DHCOPINVCons).PBOADD()
	w ##class(web.UDHCJFBILL).PBODINS()
	w ##class(UDHCJFPBOD).INSERT()
	&sql(INSERT INTO DHC_PatBillDetails Values PLIST())


4、在发票表(DHC_INVPRT)中新增一条记录

	w ##class(web.DHCOPINVCons).OPBillCharge
	w ##class(web.DHCBillCons12).ReBill()
	w ##class(web.DHCBillCons12).SaveINV()
	w ##class(web.UDHCINVPRT).INVPRT(myINVPInfo)


5、在发票表的支付方式表(DHC_INVPayMode)中新增记录信息

	w ##class(web.DHCOPINVCons).OPBillCharge
	w ##class(web.DHCBillCons12).ReBill()
	w ##class(web.DHCBillCons12).SaveINV()
	w ##class(web.UDHCINVPRTIF).INVPRTPayMode()


6、发票表与帐单表的关联表(DHC_BillConINV)新增记录信息

	w ##class(web.DHCOPINVCons).OPBillCharge
	w ##class(web.DHCBillCons12).ReBill()
	w ##class(web.DHCBillCons12).SaveINV()
	

###四、结算失败可能的原因

	1. NoOrdFoot：没结算的医嘱
	2. 支付方式为空
	3. NotApproved：医嘱需要审批才能按照当前收费类别结算,当前结算操作已取消
	4. InstypeChanged：医嘱收费类别发生了改变,请单击[确定]后重新结算
	5. NoChangeOrdInstypeCLS：缺少元素[ChangeOrdInstypeCLS]
	6. 请输入实付金额
	7. ActualMoneyError：实收金额小于应付金额.
	8. HisCancleFailed：医保取消结算成功,但HIS系统取消结算失败,请和计算机室联系解决
	9. 多种支付方式结算失败
	10. 优惠券信息保存失败
	11. 第三方支付接口结算失败
	12. 101：预结算失败门诊结算没有数据
	13. 102：预结算失败患者的支付金额不符
	14. 103：门诊收费重新生成账单错误
	15. 104：门诊收费取配置信息有误
	16. 105：门诊收费支付方式输入为空
	17. 107：门诊收费院内账户不存在
	18. 109：门诊收费员没有可用票据
	19. 112：门诊收费四舍五入舍入金额过大，请分批结算
	20. 113：门诊收费院内账户与患者身份不符
	21. 114：医嘱被执行，不能退费
	22. 120：门诊收费有异常收费记录需要处理
	23. 123：门诊收费欠费结算异常
	24. 125：账户余额不足
	25. 129：门诊收费减材料库存失败
	26. 130：门诊收费挂号费与处方不能一起结算
	27. 131：门诊收费患者结算需要附加条件
	28. 132：门诊收费同一个处方被拆分
	29. 133：门诊收费账单表金额不平，请核查
	30. 134：门诊收费发票表与账单表金额不平，请核查



##申请退费流程
1、在收据信息主表中：根据账单id修改允许作废标志置为Y、修改允许作废日期、允许作废时间、允许作废用户、允许退费原因、允许退费科室

	w ##class(web.DHCOPBillRefundRequestNew).VerifyRefundRcp()

	&sql(update DHC_INVPRT set PRT_AllowRefund='Y',PRT_AllRefundDate=:vdate,PRT_AllRefundTime=:vtime,PRT_AllRefundUser=:vUser,
	PRT_RefundReason=:RefReason, PRT_RefAuditLoc_DR=:RefAudiLocDR
	where PRT_Rowid=:INVPRTRowid)

2、在DHC_INVOEItemAuthorize表中新增一条数据

	w ##class(web.DHCOPBillRefundRequestNew).InsertAuthInfo()
	&sql(INSERT INTO DHC_INVOEItemAuthorize Values PLIST())

3、更新检查申请部位表申请退费状态

	W ##Class(web.DHCAPPExaReport).UpdPartReqFlag("11||1||1","Y")

	&SQL(update DHC_AppRepPart Set AR_RefReqFlag=:reqFlag where AR_RowID=:arRowID)

4、更新医嘱扩展表的退费审核状态(A)、退费审核用户、退费审核日期、退费审核时间、退费审核原因、退费审核科室


	w ##class(web.DHCOPBillRefundRequestNew).UpdateOEItmFAuth()

	&sql(SELECT * INTO PLIST() FROM DHC_OE_OrdItem WHERE DHCORI_RowId= :RowId)
	&sql(UPDATE DHC_OE_OrdItem VALUES PLIST() WHERE DHCORI_RowId= :RowId) 


5、在门诊退药申请子表中新增一条信息

	w ##class(web.DHCOPBillRefundRequestNew).InsertDrugReturnRequset()

	&sql(insert into sqluser.dhc_phreqitem(phreqi_phreq_parref,phreqi_child,
      phreqi_phdi_dr,phreqi_reqqty,PHReqi_ChowFlag,PHReqi_RefundReqMark)
      values(:phreqrow,:sub,:phditm,:qty,:chowflag,:InsRowID))

6、在门诊退费数量表中新增一条信息

	w ##class(web.DHCOPBillRefundRequestNew).InsertParkReturnRequset()
	&sql(INSERT INTO DHC_OERefundQty Values PLIST())

7、在发票审核表审核表中新增一条信息
	
	&sql(INSERT INTO DHC_INVOEItemAuthorize Values PLIST())

##取消退费申请流程

1、更新医嘱扩展表的退费审核状态(A)、退费审核用户、退费审核日期、退费审核时间、退费审核原因、退费审核科室


	w ##class(web.DHCOPBillRefundRequestNew).UpdateOEItmFAuth()

	&sql(SELECT * INTO PLIST() FROM DHC_OE_OrdItem WHERE DHCORI_RowId= :RowId)
	&sql(UPDATE DHC_OE_OrdItem VALUES PLIST() WHERE DHCORI_RowId= :RowId) 

2、 根据RowId修改门诊退费数量表中的信息中：退费数量、退费人、退费日期、退费时间


	w ##class(web.DHCOPBillRefundRequestNew).InsertParkReturnRequset()
	&sql(UPDATE DHC_OERefundQty VALUES PLIST() WHERE OERQ_RowID= :RowId)

3、删除发票审核表里的审核记录

	w ##class(web.udhcOPRefund).CancelAudi()
	&sql(DELETE FROM DHC_INVOEItemAuthorize where PRT_IOA_ParRef=:invPrtRowid)


4、把收据信息主表中：允许作废标志置、允许作废日期、允许作废时间、允许作废用户、允许退费原因、允许退费科室均置为null

	w ##class(web.udhcOPRefund).CancelAudi()
	w ##class(web.DHCOPBillRefundRequestNew).InsertParkReturnRequset()
	&sql(UPDATE DHC_InvPrt SET prt_allowrefund=null,prt_allrefunduser=null,prt_allrefunddate=null,prt_allrefundtime=null,PRT_RefundReason=null, PRT_RefAuditLoc_DR=null where prt_rowid=:invPrtRowid)


##收费员日报结算业务流程
1、如果先预结算，则把门诊报表结算表中的最后一条记录删除

	w ##class(web.DHCOPBillDailyHandin).Handin()
	s myrtn=##class(web.UDHCINVPRTReports).DELETE(footId)

	&SQL(DELETE FROM DHC_INVPRTReports WHERE HIS_Rowid = :RowId)

2、在门诊报表结算表中新增一条结算记录。

	w ##class(web.DHCOPBillDailyHandin).Handin()
	s myrtn=##class(web.UDHCINVPRTReports).Insert()

	&sql(insert into DHC_INVPRTReports Values PLIST())



3、增加门诊日结指标

	w ##class(web.DHCBillKPIJob).BuildDeptAccPayHandin()

	1、新增门诊子类及会计子类表的记录
	set rtn=##class(web.UDHCINVPRTReportsSub).Insert()

	&sql(insert into DHC_INVPRTReportsSub Values PLIST())

	2、新增支付方式子表的记录
	set rtn=##class(web.UDHCINVPRTReportsPaymode).Insert()

	&sql(insert into DHC_INVPRTReportsPaymode Values PLIST())

	3、新增病人费别对应的支付方式表的记录
	set rtn=##class(web.UDHCINVPRTReportsInsType).Insert()

	&sql(insert into DHC_INVPRTReportsInsType Values PLIST())

4、更新门诊收据信息主表，结帐标志为Y、结帐日期、结帐时间、关联结帐历史记录表(DHC_INVPRTReports)


	w ##class(web.DHCOPBillDailyHandin).Handin()
	s myrtn=..UpdateFootForUserNoCard(guser,stDate,stTime,endDate,endTime,HISParref,hdate,htime,hospDr)

	&sql(SELECT * INTO PLIST() FROM DHC_INVPRT WHERE PRT_Rowid= :RowId) 


5、更新卡支付票据表(此表作用只是为了核销票据)，关联结帐历史记录表(DHC_INVPRTReports)、核销标志为Y、核销日期、核销时间、核销人员

	w ##class(web.DHCOPBillDailyHandin).Handin()

	&SQL(UPDATE DHC_AccPayINV SET API_INVRep_DR=:HISParref, API_Handin='Y', API_CheckDate=:hdate, API_CheckTime=:htime, API_CheckUser_DR=:guser
	      WHERE API_RowID=:ApiRowID)

6、更新预交金表,关联结帐历史记录表(DHC_INVPRTReports)、结账标志为Y、关联卡支付与预交金结算流水帐对帐表(DHC_AccPFoot)、缴款日期、缴款时间、收款人员

	w ##class(web.DHCOPBillDailyHandin).Handin()

	&SQL(UPDATE DHC_AccPreDeposit SET AccPD_IPRep_DR=:HISParref, AccPD_Handin='Y', AccPD_pdfoot_DR=:HISParref, AccPD_FootDate=:hdate, AccPD_FootTime=:htime, AccPD_FootUser_DR=:guser
		WHERE AccPD_Rowid=:IPRowID)

7、更新账户结算表，为了方便押金回收，关联结帐历史记录表(DHC_INVPRTReports)

	w ##class(web.DHCOPBillDailyHandin).Handin()

	&SQL(UPDATE DHC_AccFootInfo	SET AccFI_IPRep_DR=:HISParref WHERE AccFI_RowID=:FIRowID)

8、更新卡发票表，关联结帐历史记录表(DHC_INVPRTReports)、结账标志为Y、结账日期、结账时间

	w ##class(web.DHCOPBillDailyHandin).Handin()

	&SQL(UPDATE DHC_CardINVPRT SET CIP_INVReports_DR=:HISParref, CIP_Handin='Y', CIP_HandinDate=:hdate, CIP_HandinTime=:htime WHERE CIP_RowID=:CIPRowID)

9、更新作废发票(跳号)表,关联结帐历史记录表(DHC_INVPRTReports)、结账标志为Y、结账日期、结账时间

	w ##class(web.DHCOPBillDailyHandin).Handin()

	&SQL(UPDATE DHC_VoidInv SET VOI_Report_DR=:HISParref, VOI_Handin='Y', VOI_HandDate=:hdate, VOI_handTime=:htime
	     WHERE VOI_Rowid=:VoidID)

10、更新急诊留观押金表，关联结帐历史记录表(DHC_INVPRTReports)、结账标志为Y、结账日期、结账时间、结账人员

	w ##class(web.DHCOPBillDailyHandin).Handin()

	&SQL(UPDATE DHC_EPPreDeposit SET EPMD_Report_DR=:HISParref, EPMD_Handin='Y', EPMD_FootDate=:hdate, EPMD_FootTime=:htime, EPMD_FootUser_DR=:guser
		WHERE EPMD_RowID=:IPRowID)


##取消收费员日报结算流程

1、更新收据信息主表、关联结帐历史记录表(DHC_INVPRTReports)为NULL,结账标志为N,结帐日期和结帐时间为NULL


	w ##class(web.DHCOPBillDailyHandin).CancelHandin(835)

	&SQL(SELECT count(*) INTO :num FROM DHC_INVPRT WHERE PRT_DHCINVPRTR_DR=:footId)

	&SQL(UPDATE DHC_INVPRT SET PRT_DHCINVPRTR_DR=NULL, PRT_Handin='N', PRT_HandinDate=NULL, PRT_HandinTime=NULL
			WHERE PRT_DHCINVPRTR_DR=:footId)


2、更新集中打印发票表，关联结帐历史记录表(DHC_INVPRTReports)为NULL、核销标志为N、核销日期、核销时间、核销人员


	w ##class(web.DHCOPBillDailyHandin).CancelHandin(835)

	&SQL(UPDATE DHC_AccPayINV SET API_INVRep_DR=NULL, API_Handin='N', API_CheckDate=NULL, API_CheckTime=NULL, API_CheckUser_DR=NULL
	   		WHERE API_INVRep_DR=:footId)

3、更新门诊预交金表，关联结帐历史记录表(DHC_INVPRTReports)为NULL、结账标志为N、关联卡支付与预交金结算流水帐对帐表(DHC_AccPFoot)、缴款日期、缴款时间、收款人员为NULL

	w ##class(web.DHCOPBillDailyHandin).CancelHandin(835)	

	&SQL(UPDATE DHC_AccPreDeposit SET AccPD_PDFoot_DR=NULL, AccPD_IPRep_DR=NULL, AccPD_Handin='N', AccPD_FootDate=NULL, AccPD_FootTime=NULL, AccPD_FootUser_DR=NULL
			WHERE AccPD_PDFoot_DR=:footId)

4、更新卡发票表，关联结帐历史记录表(DHC_INVPRTReports)为NULL、结账标志为N、结账日期、结账时间为NULL

	w ##class(web.DHCOPBillDailyHandin).CancelHandin(835)	

	&SQL(UPDATE DHC_CardINVPRT SET CIP_INVReports_DR=NULL, CIP_Handin='N', CIP_HandinDate=NULL, CIP_HandinTime=NULL 
			WHERE CIP_INVReports_DR=:footId)

5、更新账户结算表，为了方便押金回收，关联结帐历史记录表(DHC_INVPRTReports)为NULL

	&SQL(UPDATE DHC_AccFootInfo	SET AccFI_IPRep_DR=NULL WHERE AccFI_IPRep_DR=:footId)


6、更新作废发票(跳号)表,关联结帐历史记录表(DHC_INVPRTReports)为NULL、结账标志为N、结账日期、结账时间为NULL

	w ##class(web.DHCOPBillDailyHandin).CancelHandin(835)

	&SQL(UPDATE DHC_VoidInv SET VOI_Report_DR=NULL, VOI_Handin='N', VOI_HandDate=NULL, VOI_handTime=NULL
	 		WHERE VOI_Report_DR=:footId AND VOI_Type IN ('OP', 'OD'))

7、更新急诊留观押金表，关联结帐历史记录表(DHC_INVPRTReports)NULL、结账标志为N、结账日期、结账时间、结账人员为NULL


	w ##class(web.DHCOPBillDailyHandin).CancelHandin(835)

	&SQL(UPDATE DHC_EPPreDeposit SET EPMD_Report_DR=NULL, EPMD_Handin='N', EPMD_FootDate=NULL, EPMD_FootTime=NULL, EPMD_FootUser_DR=NULL
			WHERE EPMD_Report_DR=:footId)


##账户结算流程

1、查找有效发票,把要打印票据号置为当前票据号

	w ##class(web.UDHCAccManageCLS).AccFootMan
	w ##class(web.UDHCAccPrtPayFoot).BuildAccINVPay
	w ##class(web.UDHCAccPrtPayFoot).AccINVPayInsert()
	w ##class(web.udhcOPBill).UpdateReceipNO(UserDR,ReceipNew,myGroupDr)

	&sql(select INV_StartInv,inv_endinv,inv_rowid into :startno,:endno,:rowid from DHC_INVOICE 
	     where inv_rowid=(select min(inv_rowid) from dhc_invoice 
	     where inv_usr= :suser and INV_finalflag='Y' and INV_type=:myUseINVType))

	//如果要打印票据号大于截止票据号，把该发票的可用标志置为N，表示不可用
	i rcpno>endno  d
	&sql(update DHC_INVOICE set inv_finalflag='N' where inv_rowid= :rowid)

	//把要打印票据号置为当前票据号
	&sql(update DHC_INVOICE set inv_lastnum= :rcpno where inv_rowid= :rowid)

2、在综合打印发票（小票换发票,此表作用只是为了核销票据)，新增一条数据

	
	w ##class(web.UDHCAccManageCLS).AccFootMan
	w ##class(web.UDHCAccPrtPayFoot).BuildAccINVPay
	w ##class(web.UDHCAccPrtPayFoot).AccINVPayInsert()
	w ##class(web.UDHCACINVColPrt).InsertAPayINV

	&sql(INSERT INTO DHC_AccPayINV Values PLIST())


3、集中打印发票支付方式表

	w ##class(web.UDHCAccManageCLS).AccFootMan
	w ##class(web.UDHCAccPrtPayFoot).BuildAccINVPay
	w ##class(web.UDHCAccPrtPayFoot).AccINVPayInsert()
	w ##class(web.UDHCACINVColPrt).InsertAPayINVMode()

	&sql(INSERT INTO DHC_AccPayINVMode Values PLIST())

4、发票号自动累加1,并把发票号修改为当前发票号

	w ##class(web.UDHCAccManageCLS).AccFootMan
	w ##class(web.UDHCAccPrtPayFoot).BuildAccINVPay
	w ##class(web.UDHCAccPrtPayFoot).AccINVPayInsert()
	w ##class(web.UDHCACINVColPrt).InsertAPayINVMode()
	w ##class(web.UDHCAccAddDeposit).AddDeposit(AddStr)
	w ##Class(web.UDHCAccAddDeposit).UpdatePDReceipts()

	&sql(update DHC_INVOICE set inv_lastnum=:lastnum where inv_rowid=:CurReceiptsID)   

5、修改账户管理表的中的账户余额

	w ##class(web.UDHCAccManageCLS).AccFootMan
	w ##class(web.UDHCAccPrtPayFoot).BuildAccINVPay
	w ##class(web.UDHCAccPrtPayFoot).AccINVPayInsert()
	w ##class(web.UDHCACINVColPrt).InsertAPayINVMode()
	w ##class(web.UDHCAccAddDeposit).AddDeposit(AddStr)
	w ##Class(web.UDHCAccAddDeposit).UpdateAM()

	&sql(UPDATE DHC_AccManager VALUES PLIST() WHERE AccM_RowID= :RowId)


6、在预缴金流水账表新增一条记录

	w ##class(web.UDHCAccManageCLS).AccFootMan
	w ##class(web.UDHCAccPrtPayFoot).BuildAccINVPay
	w ##class(web.UDHCAccPrtPayFoot).AccINVPayInsert()
	w ##class(web.UDHCACINVColPrt).InsertAPayINVMode()
	w ##class(web.UDHCAccAddDeposit).AddDeposit(AddStr)
	w ##Class(web.UDHCAccPreDeposit).INSERT()

	&sql(INSERT INTO DHC_AccPreDeposit Values PLIST())

7、在帐户预交金的支付方式表新增一条记录

	w ##class(web.UDHCAccManageCLS).AccFootMan	
	w ##class(web.UDHCAccPrtPayFoot).BuildAccINVPay
	w ##class(web.UDHCAccPrtPayFoot).AccINVPayInsert()
	w ##class(web.UDHCACINVColPrt).InsertAPayINVMode()
	w ##class(web.UDHCAccAddDeposit).AddDeposit(AddStr)
	w ##Class(web.UDHCAccPrePayMode).INSERT()

	&sql(INSERT INTO DHC_AccPrePayMode Values PLIST())


8、更新门诊收据信息主表的票据打印标志(NoPrint||N 没有打印,Printed||P 已经打印,正常的现金收费 标记 P),关联帐户支付的集中打印发票表(DHCAccPayINV)

	w ##class(web.UDHCAccManageCLS).AccFootMan
	w ##class(web.UDHCAccPrtPayFoot).BuildAccINVPay
	w ##class(web.UDHCAccPrtPayFoot).AccINVPayInsert()
	w ##class(web.UDHCINVPRT).UpdatePrtFlag

	&sql(UPDATE DHC_INVPRT VALUES PLIST() WHERE PRT_Rowid= :RowId)

9、在集中打印发票表与支付表的关联表中新增一条记录
	
	w ##class(web.UDHCAccManageCLS).AccFootMan
	w ##class(web.UDHCAccPrtPayFoot).BuildAccINVPay
	w ##class(web.UDHCAccPrtPayFoot).AccINVPayInsert()
	w ##class(web.UDHCACINVColPrt).InsertAINVConPrt

	&sql(INSERT INTO DHC_AccPINVCONPRT Values PLIST())

10、修改卡表的有效卡标志（Normal||N  正常,Suspend||S  挂失,Reclaim||R  回收,Depose||D  作废)、取消日期、取消时间、取消人员

	w ##class(web.UDHCAccManageCLS).AccFootMan	
	w ##class(web.UDHCAccCardManage).CardStatusChange
	w ##Class(web.UDHCCardRef).UPDATE()
	
	&sql(UPDATE DHC_CardRef VALUES PLIST() WHERE CF_RowID= :RowId)


11、在卡的状态变化表中新增一条记录

	w ##class(web.UDHCAccManageCLS).AccFootMan()	
	w ##class(web.UDHCAccCardManage).CardStatusChange()
	w ##Class(web.UDHCCardStatusChange).INSERT()

	&sql(INSERT INTO DHC_CardStatusChange Values PLIST())


12、修改账户管理(预缴金统一管理)表中的,销户日期、销户时间、销户人员、帐户状态为F(结算)、帐户限支/透支额度为0、患者结算时产生坏账，给财务报坏账准备



	w ##class(web.UDHCAccManageCLS).AccFootMan()
	w ##class(web.UDHCAccManageCLS).UpAccFoot
	w ##class(web.UDHCAccManager).UPDATE()

	&sql(UPDATE DHC_AccManager VALUES PLIST() WHERE AccM_RowID= :RowId)

13、增加预交金回收机制数据,在DHC_AccFootInfo表中新增一条记录

	w ##class(web.UDHCAccManageCLS).AccFootMan()
	w ##class(web.UDHCAccManageCLS).UpAccFootInfo
	w ##class(web.UDHCAccFootInfo).INSERT()

	&sql(INSERT INTO DHC_AccFootInfo Values PLIST())

