#优惠套餐

##一、挂号使用优惠券

	1、在DHCOPAdm.Reg.js中的UpdateClickHandler方法中。
		1.1、调用CRM获取优惠政策入口
		 	w ##class(DHCBillCRMPay.OPBillPay).GetFavourInfoFromCRM("381455","7096","00000001KLsJ")
		1.2、有优惠信息时弹出窗口
			dhcbill.opbill.CRMCoupon.csp
			1.2.1、优惠计算：dhcbill/dhcopbill/dhcbill.opbill.CRMCoupon.js中的calc_Click和getSelfPayAmt
			1.2.1.1、获取发票自费金额：w ##class(DHCBillCRMPay.OPBillPay).GetPatSelfPayAmt()
			1.2.1.2、获取优惠金额：w ##class(DHCBillCRMPay.OPBillPay).CalcCouponAmt("7096","381466")
			
      		1.2.2、优惠确认：dhcbill/dhcopbill/dhcbill.opbill.CRMCoupon.js中的save_Click
			1.2.2.1 保存优惠信息：w ##class(DHCBillCRMPay.OPBillPay).SaveCouponPayInfo(7524, "381496","7050^238")
	
##二、结算使用优惠券

	1、udhcOPCharge.js中的Bill_Click方法中

		1.1、调用CRM获取优惠政策入口
		 	w ##class(DHCBillCRMPay.OPBillPay).GetFavourInfoFromCRM("381455","7096","00000001KLsJ")
	
		 根据发票ID获取医嘱项列表
		 Input:发票表RowID,优惠券号(页面上填入)
		 w ##class(DHCBillCRMPay.OPBillPay).GetArcimListByPrtRowID(381455, "00000001KLsJ").Read()
	
		 处理获取优惠信息接口返回的XML串
		 w ##class(DHCBillCRMPay.OPBillPay).FormatCouponInfoFromCRM("11")
	
	2、dhcbill.opbill.CRMCoupon.csp   //使用优惠劵页面
	  优惠计算：dhcbill/dhcopbill/dhcbill.opbill.CRMCoupon.js中的calc_Click
      优惠确认：dhcbill/dhcopbill/dhcbill.opbill.CRMCoupon.js中的save_Click
	  保存优惠信息：w ##class(DHCBillCRMPay.OPBillPay).SaveCouponPayInfo(7524, "381496","7050^238")
	  更新发票支付方式表： w ##class(web.DHCOPBillManyPaymentLogic).UpdateInvPayM(375519,"4^54.65","N^7050^238^101100002773")