<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="25" zv="Cache for Windows (x86-64) 2016.2 (Build 736_0_16871U)" ts="2019-03-25 15:02:42">
<Class name="web.DHCPE.ImportGInfo">
<ClassType/>
<Import>SQLUser</Import>
<ProcedureBlock>0</ProcedureBlock>
<Super>%Library.RegisteredObject,websys.Abstract</Super>
<TimeChanged>65093,54662.754936</TimeChanged>
<TimeCreated>60795,60684.326822</TimeCreated>

<Parameter name="BUILD">
<Internal>0</Internal>
<Default>425</Default>
</Parameter>

<Property name="JobID">
<Type>%String</Type>
<Parameter name="TRUNCATE" value="1"/>
</Property>

<Method name="SetJobID">
<ClassMethod>1</ClassMethod>
<FormalSpec>job:%String="aaaa"</FormalSpec>
<Implementation><![CDATA[	s JobID=job
]]></Implementation>
</Method>

<Method name="GetRegNoByEmploy">
<ClassMethod>1</ClassMethod>
<FormalSpec>EmployeeNo</FormalSpec>
<Implementation><![CDATA[
	q:EmployeeNo="" ""
	s ERegNo=""
	s PAPMIID=""
	f  s PAPMIID=$O(^PAPERi("EmplNo",EmployeeNo,PAPMIID)) q:PAPMIID=""  d
	.s ActiveFlag=$P(^PAPER(PAPMIID,"PAT",1),"^",6)
	.q:ActiveFlag="N"
	.s ERegNo=$P(^PAPER(PAPMIID,"PAT",1),"^",1)
	q ERegNo
]]></Implementation>
</Method>

<Method name="GetRegNoByMedical">
<ClassMethod>1</ClassMethod>
<FormalSpec>MedicalNo</FormalSpec>
<Implementation><![CDATA[
	q:MedicalNo="" ""
	s MedicalNo=$ZCVT(MedicalNo,"U")
	s MRegNo=""
	s PAPMIID=""
	f  s PAPMIID=$O(^PAPERi("Medicare1",MedicalNo,PAPMIID)) q:PAPMIID=""  d
	.s ActiveFlag=$P(^PAPER(PAPMIID,"PAT",1),"^",6)
	.q:ActiveFlag="N"
	.s MRegNo=$P(^PAPER(PAPMIID,"PAT",1),"^",1)
	q MRegNo
]]></Implementation>
</Method>

<Method name="GetGPersonInfo">
<Description>
检验个人信息是否符合条件
w ##class(web.DHCPE.ImportGInfo).GetGPersonInfo()
InString TName^RegNo^Name^CardNo^Sex^Age^Birth^Married^MoveTel^Tel^Address^StartDate^EndDate^AsCharged^IReportSend^ChargedMode^AddItem^AddItemLimit^AddItemAmount^AddMedical^AddMedicalLimit^AddMedicalAmount</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>GID,InString,Type:%String="Import",job:%String="aaaa",GDesc,AllowCF:%String=""</FormalSpec>
<Implementation><![CDATA[
	s ^tempwml("GetGPersonInfo")=$lb(GID,InString,Type,job,GDesc,AllowCF)
	new GenModel
	s $zt="GetErr"
	//s ^TMPDHCPE("InString",InString)=InString
	s ErrInfo=""
	d ..SetJobID(job)
	s RowSort=$p(InString,"^",$L(InString,"^"))
	s TName=$p(InString,"^",1)

	;s CardNoJZ=$p(InString,"^",29)   //就诊卡号
	s CardNoJZ=$p(InString,"^",37)
	s RegNo=$p(InString,"^",2)
	s GenModel=##class(web.DHCPE.Public.Setting).GetPAPMINoGenModel()
	s:(GenModel'="NoGen")&&(RegNo="") ErrInfo=..IsVaild("登记号不能为空"_$c(10),Type)
	
	s RegNo=##class(web.DHCPE.DHCPECommon).RegNoMask(RegNo)
	
	//根据工号和病案号找ID号
	
	;s EmployeeNo=$p(InString,"^",31)
	s EmployeeNo=$p(InString,"^",15)
	;s InMedicare=$p(InString,"^",32)
	s InMedicare=$p(InString,"^",38)
	s MRegNo=..GetRegNoByMedical(InMedicare)
	s:(InMedicare'="")&&(MRegNo="") ErrInfo=ErrInfo_..IsVaild("病案号对应的登记号不存在:"_InMedicare_$c(10),Type)
	/*
	i MRegNo="" d
	s ERegNo=..GetRegNoByEmploy(EmployeeNo)
	q:(EmployeeNo'="")&&(ERegNo="") ..IsVaild("工号对应的登记号不存在:"_EmployeeNo,Type)
	q:(MRegNo'=ERegNo)&&(ERegNo'="")&&(MRegNo'="") ..IsVaild("工号登记号:"_ERegNo_"和病案号对应的登记号:"_MRegNo_"不一致",Type)
	s:ERegNo'="" MRegNo=ERegNo
	*/
	s:(RegNo'=MRegNo)&&(MRegNo'="")&&(RegNo'="") ErrInfo=ErrInfo_..IsVaild("病案号对应的ID:"_MRegNo_"和所给登记号:"_RegNo_"不一致"_$c(10),Type)
	i MRegNo'="" s RegNo=MRegNo
	
	i RegNo'=""
	{
		s PAPID=$o(^PAPERi("PAPMI_PatNo",RegNo,""))
		s:PAPID="" ErrInfo=ErrInfo_..IsVaild("登记号不正确:"_RegNo_$c(10),Type)
		s OldEmpNo=$P($g(^PAPER(PAPID,"EMP")),"^",5)
		i (+OldEmpNo'=+EmployeeNo)&&(EmployeeNo'="")&&(OldEmpNo'=""){
			;s ERegNo=..GetRegNoByEmploy(EmployeeNo)
			;q:(ERegNo'="")&&(ERegNo'=RegNo) ..IsVaild("工号ID:"_ERegNo_"和病案号ID"_RegNo_"不一致:"_$c(10),Type)
			s ErrInfo=ErrInfo_..IsVaild(PAPID_"所给工号:"_EmployeeNo_"和原工号不一致:"_OldEmpNo_$c(10),Type)
		}
		
	}
	//根据工号和病案号找ID号End
	//工种和接害工龄  
	s WorkTypeID="", EndangerWorkAge="" ,WorkType="" 
	;s WorkTypeID=$p(InString,"^",34)
	s WorkTypeID=$p(InString,"^",40)
	i WorkTypeID'="" s WorkType=$o(^User.DHCPEWorkTypeI("WTDescIndex",""_WorkTypeID,0))  //按名称检索
	;s EndangerWorkAge=$p(InString,"^",35) 
    s EndangerWorkAge=$p(InString,"^",41) 
    
    s PatFeeType=$p(InString,"^",42)   //体检类别 add by wangminglong 2019-3-21 start
	
	s Name=$p(InString,"^",3)
	i Name="" s ErrInfo=ErrInfo_..IsVaild("姓名不能为空"_$c(10),Type)
	
	s RegNoFlag=..CheckRegNo(.RegNo,.CardNoJZ)
	s:RegNoFlag'=1 ErrInfo=ErrInfo_..IsVaild("无效的个人登记号:"_RegNoFlag_$c(10),Type)
	
	s NameFlag=##class(web.DHCPE.ImportGInfo).CheckName(RegNo,Name)
	s:NameFlag=1 ErrInfo=ErrInfo_..IsVaild("登记号"_RegNo_"对应的名字,和现有名字不符"_$c(10),Type)
	;s Sex=$p(InString,"^",5)
	s Sex=$p(InString,"^",6)
	s Sex=..GetSexId(Sex)
	i Sex="" s ErrInfo=ErrInfo_..IsVaild("性别设置不正确"_$c(10),Type)
	
	s SexFlag=##class(web.DHCPE.ImportGInfo).CheckSex(RegNo,Sex)
	s:SexFlag=1 ErrInfo=ErrInfo_..IsVaild("登记号"_RegNo_"对应的性别,和现有性别不符"_$c(10),Type)
	
	s CredentialsType=$p(InString,"^",4)
	i CredentialsType="" s ErrInfo=ErrInfo_..IsVaild("证件类型不能为空"_$c(10),Type)
	i (CredentialsType'="")&&('$D(^PAC("CARD",0,"Code",$$ALPHAUP^SSUTIL4(CredentialsType)))) s ErrInfo=ErrInfo_..IsVaild("证件类型无效"_$c(10),Type)
	i (CredentialsType'="") d
	.s CredentialsType=$O(^PAC("CARD",0,"Code",$$ALPHAUP^SSUTIL4(CredentialsType),""))
	s CardNo=$p(InString,"^",5)  //身份证
	i CardNo="" s ErrInfo=ErrInfo_..IsVaild("证件号码不能为空"_$c(10),Type)
	s CardNo=##class(web.DHCPE.Public.Setting).Replace(CardNo," ","")
	s CardNo=##class(web.DHCPE.Public.Setting).Replace(CardNo,"'","")
	s CardNo=##class(web.DHCPE.Public.Setting).Replace(CardNo,$C(10),"")
	s CardNo=##class(web.DHCPE.Public.Setting).Replace(CardNo,$C(13),"")

	s exitName=0 
	s exitSex=0
	s CardNoIndex=$ZCVT(CardNo,"U")
	S:$L(CardNoIndex)'=$L(CardNo) ErrInfo=ErrInfo_..IsVaild("身份证号"_CardNo_"有异常字符"_$C(10),Type)
	s Flag=..CheckRegNoByCardId(CardNoIndex,RegNo,Type)
	s IDRegFlag=Flag
	
	i (RegNo="")&&(+Flag>0)  d
	.s RegNo=$p(Flag,"^",$l(Flag,"^"))
	.s papmirowid=""
	.s papmirowid=$o(^PAPERi("PAPMI_PatNo",RegNo,""))
    .s name=$p(^PAPER(papmirowid,"ALL"),"^",1)
    .s sexid=$p(^PAPER(papmirowid,"ALL"),"^",7)
    .s sex=$p(^CT("SEX",sexid),"^",2)
    .s Sexname=$p(^CT("SEX",Sex),"^",2)
    .i name'=Name s exitName=1
    .i sexid'=Sex   s exitSex=1
    
    i exitName=1 s ErrInfo=ErrInfo_..IsVaild("系统中已存在身份证号为:"_CardNo_"的病人,姓名为:"_name_",与所导姓名"_Name_"不相符"_$c(10),Type)
	i exitSex=1  s ErrInfo=ErrInfo_..IsVaild("系统中已存在身份证号为:"_CardNo_"的病人,姓名为:"_name_",性别为:"_sex_"与所导性别"_Sexname_"不相符"_$c(10),Type)
	//验证有相同人员给与提示
	s CheckFlag=1                                             //add by zhouli start
	if CardNoIndex'=""  d
	 .i '$d(^DHCPEImportGInfo("CheckCardId",JobID,CardNoIndex))   s ^DHCPEImportGInfo("CheckCardId",JobID,CardNoIndex)=Name
	 .else  s CheckFlag=0
	i CheckFlag=0  s ErrInfo=ErrInfo_..IsVaild("身份证相同的人在导入模板里已存在"_$c(10),Type)    //add by zhouli end
	e  d
	.q:RegNo=""
	.s PIBI=$O(^DHCPEPreIBI(0,"PAPMINo",RegNo,0))
	.q:PIBI=""
	.s ExistFlag=##class(web.DHCPE.PreIADM).GroupIsExistIADM(PIBI,GID)
	.i ExistFlag=1 d
	..s:AllowCF'="1" ErrInfo=ErrInfo_..IsVaild("登记号相同的人在团体里已存在"_$c(10),Type)

	
	;s Age=$p(InString,"^",6)
	s Age=$p(InString,"^",7)
	;s Birth=$p(InString,"^",7)
	s Birth=$p(InString,"^",8)
	i (Birth="")&&(Age="")&&(RegNo'="")  d
	.s ReturnStr=..CheckBodAndAgeByRegNo(RegNo)
	.s Birth=$p(ReturnStr,"^",1)
	.s Age=$p(ReturnStr,"^",2)
	i (Birth="")&&(Age="") s ErrInfo=ErrInfo_..IsVaild("年龄或者生日必须设置一个"_$c(10),Type)
	i Birth="" d
	.s Year=$ZD($H,3)
	.s ReduceYear=(+Year)-Age
	.s $p(Year,"-",1)=ReduceYear
	.s $p(Year,"-",3)="28"
	.s Birth=Year
	i Birth'="" s Birth=$ZDH(Birth,3)
	
	
	i Type="Check"
	{   
		s Flag=..CheckRegNoInGroupByName(Name,Sex,Age,Type,JobID,GDesc)
		i Flag'=0 s ErrInfo=ErrInfo_..IsVaild("团体中姓名、性别、年龄相同的登记号还存在,登记号为"_Flag_$c(10),Type)
	}
    
	i Type="Check"
	{
		s Flag=..CheckRegNoByDobName(Birth,Name,RegNo,Sex,Type)
		i +Flag>0 s ErrInfo=ErrInfo_..IsVaild("姓名生日性别相同的卡号还存在,卡号为"_Flag_$c(10),Type)
	}

	;s Married=$p(InString,"^",8)
	s Married=$p(InString,"^",9)
	s Married=..GetMarried(Married)
	//i Married="" q ..IsVaild("婚否设置不正确",Type)
	
	//##class(web.DHCDocCommon).GetAgeDescNew($zd(TAge,3),"")
	s realage=##class(web.DHCDocCommon).GetAgeDescNew($zd(Birth,3),"")
	s realage=$p(realage,"岁",1)
	s:(realage<18) ErrInfo="未满18岁"
	
	//根据条件得到分组ID
	s TeamId=..GetTIDByInfo(TName,Birth,Sex,Married,GID)
	
	i TeamId="" s ErrInfo=ErrInfo_..IsVaild("没有找到正确的分组"_$c(10),Type)
	s Sort=+$G(^DHCPEImportGInfo("ImportG",JobID,"Sort"))
	s Sort=Sort+1
	s TInfo="^^^"_$G(^DHCPEPreGADM(+TeamId,"Team",$p(TeamId,"||",2))) //增加^^^是为了和原来的统一
	//i $p(TInfo,"^",4)'=TName q ..IsVaild("分组名称不正确",Type)
	
	;s MoveTel=$p(InString,"^",9)
	s MoveTel=$p(InString,"^",10)
	;s Tel=$p(InString,"^",10)
	s Tel=$p(InString,"^",11)
	/*
	s Position=$p(InString,"^",26)
	s TempSort=$O(^DHCPEWRZ(Name,""),-1)
	s TempSort=+TempSort+1
	s ^DHCPEWRZ(Name,TempSort)=Birth_"^"_Sex_"^"_Position_"^"_Tel_"^"_TeamId
	s ^DHCPEWRZ=+$G(^DHCPEWRZ)+1
	*/
	
	
	;s Address=$p(InString,"^",26) ;11  部门和联系地址互换
	s Address=$p(InString,"^",34)
	;s StartDate=$p(InString,"^",12)
	s StartDate=$p(InString,"^",16)
	i StartDate'="" d
	.s StartDate=$ZDH(StartDate,3)
	e  d
	.;s StartDate=$p(TInfo,"^",5)
	.s StartDate=+$h
	s Date=+$h
	s:StartDate<Date ErrInfo="体检开始日期小于当天,不能预约"
	s EndDate=StartDate
	/*s EndDate=$p(InString,"^",13)
	i EndDate'="" d
	.s EndDate=$ZDH(EndDate,3)
	e  d
	.;s EndDate=$p(TInfo,"^",6)
	.s EndDate=+$h*/
	
	s GInfo="^"_$G(^DHCPEPreGADM(GID)) //增加^是为了和原来的统一
	
	;s IReportSend=$p(InString,"^",15)
	s IReportSend=$p(InString,"^",24)
	i IReportSend="统取" d
	.s IReportSend="GS"
	e  i IReportSend="自取" d
	.s IReportSend="IS"
	e  d
	.s IReportSend=$p(GInfo,"^",16)
	
	;s ChargedMode=$p(InString,"^",16)
	s ChargedMode=$p(InString,"^",25)
	i ChargedMode="统结" d
	.s ChargedMode="GD"
	e  i ChargedMode="自结" d
	.s ChargedMode="ID"
	e  d
	.s ChargedMode=$p(TInfo,"^",22)
	.s:ChargedMode="" ChargedMode=$p(GInfo,"^",17)
	
	;s AsCharged=$p(InString,"^",14)
	s AsCharged=$p(InString,"^",23)
	i AsCharged="是" d
	.s AsCharged="Y"
	e  i AsCharged="否" d
	.s AsCharged="N"
	e  d
	.s AsCharged=$p(GInfo,"^",8)
	.i ChargedMode="ID" s AsCharged="N"
	
	;s AddItem=$p(InString,"^",17)
	s AddItem=$p(InString,"^",26)
	i AddItem="是" d
	.s AddItem="Y"
	e  i AddItem="否" d
	.s AddItem="N"
	e  d
	.s AddItem=$p(TInfo,"^",9)
	
	;s AddItemLimit=$p(InString,"^",18)
	s AddItemLimit=$p(InString,"^",27)
	i AddItem="N" d
	.s AddItemLimit="N"
	e  d
	.i AddItemLimit="是" d
	..s AddItemLimit="Y"
	.e  i AddItemLimit="否" d
	..s AddItemLimit="N"
	.e  d
	..s AddItemLimit=$p(TInfo,"^",10)
	
	;s AddItemAmount=$p(InString,"^",19)
	s AddItemAmount=$p(InString,"^",28)
	i AddItemLimit="N" d
	.s AddItemAmount=""
	e  d
	.i AddItemAmount="" d
	..s AddItemAmount=$p(TInfo,"^",11)
	
	;s AddMedical=$p(InString,"^",20)
	s AddMedical=$p(InString,"^",29)
	i AddMedical="是" d
	.s AddMedical="Y"
	e  i AddMedical="否" d
	.s AddMedical="N"
	e  d
	.s AddMedical=$p(TInfo,"^",12)
	
	;s AddMedicalLimit=$p(InString,"^",21)
	s AddMedicalLimit=$p(InString,"^",30)
	i AddMedical="N" d
	.s AddMedicalLimit="N"
	e  d
	.i AddMedicalLimit="是" d
	..s AddMedicalLimit="Y"
	.e  i AddMedicalLimit="否" d
	..s AddMedicalLimit="N"
	.e  d
	..s AddMedicalLimit=$p(TInfo,"^",13)
	
	;s AddMedicalAmount=$p(InString,"^",22)
	s AddMedicalAmount=$p(InString,"^",31)
	i AddMedicalLimit="N" d
	.s AddMedicalAmount=""
	e  d
	.i AddMedicalAmount="" d
	..s AddMedicalAmount=$p(TInfo,"^",14)
	//s CheckInfo=..IsValidGTeamIADM(Sex,Birth,Married,TInfo)
	//q:CheckInfo'="" ..IsVaild(CheckInfo,Type)
	;s Company=$p(InString,"^",23)
	s Company=$p(InString,"^",12)
	;s Nation=$p(InString,"^",24)
	s Nation=$p(InString,"^",32)
	;s NewCard=$p(InString,"^",25)
	s NewCard=$p(InString,"^",33)
	i NewCard="是"
	{
		i GenModel="NoGen"
		{
			i +RegNo'=0 s ErrInfo=ErrInfo_..IsVaild("新发卡设置不正确"_$c(10),Type)
		}
		else
		{
			i GenModel="FreeCreate"
			{
				s PAPID=$o(^PAPERi("PAPMI_PatNo",RegNo,""))
				i PAPID'="" s ErrInfo=ErrInfo_..IsVaild("新发卡设置不正确"_$c(10),Type)
			}
			else
			{
				i PAName'="未用" s ErrInfo=ErrInfo_..IsVaild("新发卡设置不正确"_$c(10),Type)
			}
		}
		
	}
	s User=%session.Get("LOGON.USERID")
	s Date=+$H
	;s Position=$p(InString,"^",11)  ;26
	s Position=$p(InString,"^",14)
	i Position="" d
	.s Depart="无部门"
	e  d
	.s Depart=Position
	;s PatType=$p(InString,"^",27)
	s PatType=$p(InString,"^",35)
	s PatType=..GetPatTypeId(PatType)
	
	i PatType="" d
	.s PatType=$G(^DHCPESetting("DHCPE","DefPatientType"))
	.s PatType=+PatType
	
	;s HCADesc=$p(InString,"^",28)
	s HCADesc=$p(InString,"^",36)
	s HCADR=..GetHCADR(HCADesc)
	s DepLoc=%session.Get("LOGON.CTLOCID")                     //add 2009-07-02
	s VIPDesc=""
	;s VIPDesc=$p(InString,"^",30)
	s VIPDesc=$p(InString,"^",21)
	s VIPLevel=""
	//合肥京东方增加套餐代码、证件类型代码、证件号
	;s OrdSetsCodes=$p(InString,"^",36)
	s OrdSetsCodes=$p(InString,"^",18)
	i OrdSetsCodes="" s ErrInfo=ErrInfo_..IsVaild("套餐不能为空"_$c(10),Type)
	i VIPDesc'="" d
	.s VIPID=0,VIP=0
	.f  s VIPID=$o(^DHCPEVIPLevel("VIP",VIPID)) q:(VIPID="")||(VIP=1)  d
	..s Desc=$p(^DHCPEVIPLevel("VIP",VIPID),"^",2)
	..i Desc=VIPDesc d
	...s VIPLevel=VIPID
	...s VIP=1
	e  d
	.;e  s VIPLevel=$g(^DHCPEVIPLevel("PGT",TeamId))
	.s VipCode=$p(OrdSetsCodes,"&",1)
	.i VipCode="PEVIP" s VipLevel=2
	.i VipCode="PEPT"  s VipLevel=1
	;s Post=$p(InString,"^",33)
	s Post=$p(InString,"^",39)
	//合肥京东方增加套餐代码、证件类型代码、证件号
	;s OrdSetsCodes=$p(InString,"^",36)
	;s OrdSetsCodes=$p(InString,"^",18)
	;i OrdSetsCodes="" s ErrInfo=ErrInfo_..IsVaild("套餐不能为空"_$c(10),Type)
	
	;s additemsCodes=$p(InString,"^",39)
	s additemsCodes=$p(InString,"^",20)
	;s CredentialsType=$p(InString,"^",37)
	;s ^yk("card")=CredentialsType
	
	//i CredentialsType="" s ErrInfo=ErrInfo_..IsVaild("证件类型不能为空"_$c(10),Type)
	//i (CredentialsType'="")&&('$D(^PAC("CARD",0,"Code",$$ALPHAUP^SSUTIL4(CredentialsType)))) s ErrInfo=ErrInfo_..IsVaild("证件类型无效"_$c(10),Type)
	
	//证件类型转换
	//i (CredentialsType'="") d
	//.s CredentialsType=$O(^PAC("CARD",0,"Code",$$ALPHAUP^SSUTIL4(CredentialsType),""))
	
	//s CredentialsNo=$p(InString,"^",38)
	//i (CredentialsNo="")&&(CardNo="") s ErrInfo=ErrInfo_..IsVaild("证件号码或身份证号不能为空"_$c(10),Type)
	//i (CardNo="")&&(CredentialsNo'="") s CardNo=CredentialsNo
	i (+IDRegFlag>0)&&(Type'="Import")  s ErrInfo=ErrInfo_..IsVaild("身份证相同的登记号还存在,登记号为&"_IDRegFlag,Type)
	q:ErrInfo'="" ..IsVaild(ErrInfo,Type)
	s ^DHCPEImportGInfo("ImportG",JobID,"GTeam",TeamId,"IBaseInfo",Depart,Sort)="^"_RegNo_"^"_Name_"^"_Sex_"^"_Birth_"^"_PatType_"^"_Tel_"^^"_MoveTel_"^"_CardNo_"^^"_Position_"^"_Company_"^^"_Address_"^"_Nation_"^^"_Married_"^^"_Date_"^"_User_"^"_HCADR_"^"_CardNoJZ_"^"_VIPLevel_"^"_EmployeeNo_"^"_CredentialsType_"^"_RowSort      ;RowSort一定放到所有的最后 
	s Time=$p($H,",",2)
	s ^DHCPEImportGInfo("ImportG",JobID,"GTeam",TeamId,"IADM",Depart,Sort)="^^^^"_StartDate_"^"_EndDate_"^"_Time_"^^"_"PREREG^"_AsCharged_"^"_AddItem_"^"_AddItemLimit_"^"_AddItemAmount_"^"_AddMedical_"^"_AddMedicalLimit_"^"_AddMedicalAmount_"^"_IReportSend_"^"_ChargedMode_"^"_VIPLevel_"^^^"_User_"^"_Date_"^"_Time_"^^"_Post_"^"_DepLoc_"^"_WorkType_"^"_EndangerWorkAge_"^"_OrdSetsCodes_"^"_additemsCodes_"^"_PatFeeType   //添加PatFeeType 体检类型 add by wangminglong 2019-3-21 start
	s ^DHCPEImportGInfo("ImportG",JobID,"Sort")=Sort
	
	//当导入客户是没有填写预约时间,该客户发送短信时需要的标志 add by wangminglong 2019-3-14 start
	i (^DHCPEPreDate("flag")=1) d
	.s ^DHCPEImportGInfo("ImportGroup",JobID,"Flag",Sort)=1  // 1 表示该客户发送短信时需要的标志 
	.s ^DHCPEPreDate("flag")=0       // 1 表示导入客户是没有填写预约时间
	e  d
	.s ^DHCPEImportGInfo("ImportGroup",JobID,"Flag",Sort)=0
	//当导入客户是没有填写预约时间,该客户发送短信时需要的标志 add by wangminglong 2019-3-14 end
	q 0
GetErr
	//TROLLBACK
	//q $ZERROR
	q $g(TName)_"^"_$g(Birth)_"^"_$g(Sex)_"^"_$g(Married)_"^"_$g(GID)_"^错误:"_$G(Name)_$ZERROR
]]></Implementation>
</Method>

<Method name="CheckRegNoByCardId">
<Description>
根据身份证判断是否已经有卡存在1有 0没有
w ##class(web.DHCPE.ImportGInfo).CheckRegNoByCardId("110104195701050078","","Import")</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>CardNoIndex,RegNo,Type:%String="Import"</FormalSpec>
<Implementation><![CDATA[
	new (CardNoIndex, RegNo, Type)
	s PAPMIId=0
	s bFlag=0
	s Flag=0
	s rRegNo=""
	i CardNoIndex="" q bFlag
	s curRegNo=..GetRegNoByIDCard(CardNoIndex)
	
	q:curRegNo="" "0"
	q:(Type="Import")&&(RegNo=curRegNo) "0"
	q curRegNo
]]></Implementation>
</Method>

<Method name="IsVaild">
<Description>
判断信息不符合的时候退出</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>String,Type:%String="Import"</FormalSpec>
<Implementation><![CDATA[
	//i Type="Import" d ..KillImportGlobal(JobID)
	//k ^DHCPEImportGInfo("ImportG",JobID)
	q String
]]></Implementation>
</Method>

<Method name="GetMarried">
<Description>
根据婚否描述得到婚否ID</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Married</FormalSpec>
<Implementation><![CDATA[
	i Married="" q ""
	s Married=$o(^CT("MAR",0,"Desc",Married,0))
	q Married
]]></Implementation>
</Method>

<Method name="GetSexId">
<Description>
根据性别描述得到性别ID</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Sex</FormalSpec>
<Implementation><![CDATA[
	i Sex="" q ""
	s Sex=$o(^CT("SEX",0,"Desc",Sex,0))
	q Sex
]]></Implementation>
</Method>

<Method name="GetPatTypeId">
<Description>
根据分类描述得到分类信息
w ##class(web.DHCPE.ImportGInfo).GetPatTypeId("医保")</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>PatType</FormalSpec>
<Implementation><![CDATA[
	i PatType="" q ""
	s PatType=$o(^CT("SS",0,"Desc",PatType,0))
	q PatType
]]></Implementation>
</Method>

<Method name="GetHCADR">
<Description>
得到健康区域的Id</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>HCADesc</FormalSpec>
<Implementation><![CDATA[
	i HCADesc="" q ""
	s HCADesc=$ZCVT(HCADesc,"U")
	s HCADR=$o(^CT("HCA",0,"Desc",HCADesc,0))
	q HCADR
]]></Implementation>
</Method>

<Method name="Main">
<Description>
导入数据库数据信息 w ##class(web.DHCPE.ImportGInfo).Main(4,5888)</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>GID,job:%String="aaaa"</FormalSpec>
<Implementation><![CDATA[
	k PreGADMList,PreGBaseInfoList	
	s ^TMPCRMCOMPANYID=""
	s ^tempwml("Main")=$lb(GID,job)
	d ..SetJobID(job)
	;k ^DHCPEImportGInfo("ImportGErr",GID,JobID)
	s SQLCODE=0
	s ErrRows=""
	s SussNum=0
	//TSTART
	s tsub=0
	f  s tsub=$O(^DHCPEPreGADM(GID,"Team",tsub)) q:(tsub="")||(SQLCODE'=0)  d
	.s TeamID=GID_"||"_tsub
	.s Depart=""
	.f  s Depart=$O(^DHCPEImportGInfo("ImportG",JobID,"GTeam",TeamID,"IBaseInfo",Depart)) q:(Depart="")||(SQLCODE'=0)  d
	..s sort=0
	..f  s sort=$O(^DHCPEImportGInfo("ImportG",JobID,"GTeam",TeamID,"IBaseInfo",Depart,sort)) q:(sort="")||(SQLCODE'=0)  d
	...TSTART
	...s SQLCODE=..ImportIADM(GID,TeamID,Depart_"^"_sort,"TeamID")
	...TCOMMIT:SQLCODE=0
	...//q:SQLCODE'=0
	...TROLLBACK:SQLCODE'=0
	...s:SQLCODE=0 SussNum=SussNum+1
	...q:SQLCODE=0
	...s Info=$G(^DHCPEImportGInfo("ImportG",JobID,"GTeam",TeamID,"IBaseInfo",Depart,sort))
	...s RowSort=$P(Info,"^",$L(Info,"^"))
	...i ErrRows="" d
	....s ErrRows=RowSort
	...e  d
	....s ErrRows=ErrRows_"^"_RowSort
	...s ^DHCPEImportGInfo("ImportGErr",GID,JobID,RowSort)=Info
	
	d ##class(web.DHCPE.GAdmRecordManager).Insert(GID,"P","Import","","")
	d ##class(web.DHCPE.PreIADM).UpdateGroupAuditAmount(GID)
	//TCOMMIT
	d ..KillImportGlobal(JobID)
	q SQLCODE_"^"_GID_"^"_"错误数据请查看sheet1"_"^"_SussNum
]]></Implementation>
</Method>

<Method name="ImportIADM">
<Description>
导入个人信息  
Type不为空的时候就是根据分组Id导入</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>PreGADMID,TeamID,RegNo,Type:%String=""</FormalSpec>
<Implementation><![CDATA[
	k IBaseInfoLIST,IADMLIST
	s ^tempwml("ImportIADM",$h)=$lb(PreGADMID, TeamID, RegNo, Type)
	s Sort=$P(RegNo,"^",2)  //导入客户的顺序 add by wangminglong 2019-3-14 
	s Depart=$P(RegNo,"^",1)
	s RegNo=$P(RegNo,"^",2)
	s IBaseInfo=$G(^DHCPEImportGInfo("ImportG",JobID,"GTeam",TeamID,"IBaseInfo",Depart,RegNo))
	s IBaseInfo=##class(web.DHCPE.Public.Setting).Replace(IBaseInfo," ","")
	s RealRegNo=$P(IBaseInfo,"^",2)
	s IBaseInfoID=""
	i RealRegNo'="" d
	.s IBaseInfoID=$o(^DHCPEPreIBI(0,"PAPMINo",RealRegNo,""))
	
	s SQLCODE=..UpdateHISPersonData(.RealRegNo,IBaseInfo)
	q:SQLCODE'=0 SQLCODE
	s $P(IBaseInfo,"^",2)=RealRegNo
	s i=$L(IBaseInfo,"^")-4
	f j=1:1:i
	{
		s IBaseInfoLIST(j)=$P(IBaseInfo,"^",j)
	}
	k IBaseInfoLIST(1)
	s OldInfo=##class(web.DHCPE.ModifyRecord).GetInfo(IBaseInfoID,"IBaseInfo")
	i IBaseInfoID="" d
	.&SQL(Insert Into SQLUSER.DHC_PE_PreIBaseInfo Values :IBaseInfoLIST())
	.s ^DHCPEVIPLevel("PIBI",IBaseInfoLIST(2))=$P(IBaseInfo,"^",24)
	e  d
	.&SQL(Update SQLUSER.DHC_PE_PreIBaseInfo Values :IBaseInfoLIST() 
		where PIBI_RowId = :IBaseInfoID)
	q:SQLCODE'=0 SQLCODE
	s IBaseInfoID=%ROWID
	s IADMInfo=$G(^DHCPEImportGInfo("ImportG",JobID,"GTeam",TeamID,"IADM",Depart,RegNo))
	s NewInfo=##class(web.DHCPE.ModifyRecord).GetInfo(IBaseInfoID,"IBaseInfo")
	d ##class(web.DHCPE.ModifyRecord).Save(IBaseInfoID,"IBaseInfo",OldInfo,NewInfo, %session.Get("LOGON.USERID"))
	s i=$L(IADMInfo,"^")
	//把i-4改为i-5 add by wangminglong 2019-3-21
	f j=1:1:i-5
	{
		s IADMLIST(j)=$P(IADMInfo,"^",j)
	}
	
	s WorkType=$p(IADMInfo,"^",(i-4))    //把i-3改为i-4 add by wangminglong 2019-3-21
	s EndangerWorkAge=$p(IADMInfo,"^",i-3)  //把i-2改为i-3 add by wangminglong 2019-3-21
	s OrdSetsCodes=$p(IADMInfo,"^",i-2)  ;套餐代码  以,分割 //把i-1改为i-2 add by wangminglong 2019-3-21
	s additemscodes=$p(IADMInfo,"^",i-1) //把i改为i-1 add by wangminglong 2019-3-21
	//体检类别  add by wangminglong 2019-3-21 start
	s PatFeeTypeDesc=$p(IADMInfo,"^",i)  
	s PatFeeType=""
	i PatFeeTypeDesc="普通客户" s PatFeeTypeDesc="普通病人"
	i PatFeeTypeDesc="特殊客户" s PatFeeTypeDesc="特殊病人"
	i PatFeeTypeDesc'="" s PatFeeType=$o(^PAC("SUBT",0,"Desc",PatFeeTypeDesc,""))
	//体检类别  add by wangminglong 2019-3-21 end
	
	k IADMLIST(1)
	s IADMLIST(2)=IBaseInfoID
	s IADMLIST(3)=PreGADMID
	s IADMLIST(4)=TeamID
	q:(IADMLIST(4)="") -101
	s:IADMLIST(27)="" IADMLIST(27)=%session.Get("LOGON.CTLOCID")
	s IADMLIST(29)="N"
	s NewHPNo=##class(web.DHCPE.PreIADMEx).GetNewHPNo(IADMLIST(29), IADMLIST(19), IADMLIST(3), IADMLIST(27))
	s IADMLIST(28)=NewHPNo
	s IADMLIST(26)=PatFeeType    // 体检类别  add by wangminglong 2019-3-21 start
	
	s RoomPlace=$G(^DHCPEDataEx("DHCPEPreGTeam","RoomPlace",TeamID))
	s IADMLIST(8)=RoomPlace
	
	&SQL(
			Insert Into SQLUSER.DHC_PE_PreIADM Values :IADMLIST()
		)
	q:SQLCODE'=0 SQLCODE
	s IADMID=%ROWID
	
	//导入客户是没有填写预约时间,该客户发送短信时需要的标志 add by wangminglong 2019-3-14 start
	i ($g(^DHCPEImportGInfo("ImportGroup",JobID,"Flag",Sort))=1) d
	.s ^DHCPEPreDate("date",IADMID)=1  //1表示该客户发送短信时需要的标志 
	e  d
	.s ^DHCPEPreDate("date",IADMID)=0
	//导入客户是没有填写预约时间,该客户发送短信时需要的标志 add by wangminglong 2019-3-14 end
	
	s TFeeType=$G(^DHCPEDataEx("DHCPEPreGADM","ADMFeeType",TeamID))
	s ^DHCPEDataEx("DHCPEPreIADM","ADMFeeType",IADMID)=TFeeType
	s ^DHCPEDataEx("DHCPEPreIADM","Position",IADMID)=$P(IBaseInfo,"^",12)
	s Endanger=$g(^DHCPEDataEx("DHCPEPreGADM","TeamEndanger",TeamID))
    s OMEType=$g(^DHCPEDataEx("DHCPEPreGADM","OMEType",TeamID))
    s Str=##class(web.DHCPE.OccupationalDisease).SaveOccu2(IADMID,Endanger,OMEType,WorkType,EndangerWorkAge)

    s ^DHCPEDataEx("DHCPEPreIADM","RoomPlace",IADMID)=RoomPlace
    
	i IADMLIST(4)'=""
	{
		s ^DHCPEDataEx("DHCPEPreIADM","GTEAM",IADMLIST(4))=+$G(^DHCPEDataEx("DHCPEPreIADM","GTEAM",IADMLIST(4)))+1
		s ^DHCPEDataEx("DHCPEPreIADM","GTEAM","IADM",IADMID)=$G(^DHCPEDataEx("DHCPEPreIADM","GTEAM",IADMLIST(4)))
	}
	s SQLCODE=##class(web.DHCPE.PreIADM).InsertPreAudit(IADMID,1)
	q:SQLCODE'=0 SQLCODE
	s UpdateUser=%session.Get("LOGON.USERID")   //操作人ID
	i Type'=""
	{
		s SQLCODE=##Class(web.DHCPE.PreItemList).IInsOrd4NewPat(TeamID, IADMID, %session.Get("LOGON.USERID"),"0")
		i ""=SQLCODE s SQLCODE=0
		;好医通导入套餐
		i OrdSetsCodes'="" 
		{	
			s AddEntRet=""
			f i=1:1:$L(OrdSetsCodes,",")  q:AddEntRet'=""  d
			.s OrdSetsCode=$P(OrdSetsCodes,",",i) 
			.s OrdSetsId=$O(^ARCOS(0,"Code",$$ALPHAUP^SSUTIL4(OrdSetsCode),""))
			.q:OrdSetsId=""	
			.s AddEntRet=##class(web.DHCPE.PreItemList).IInsertItem(IADMID,"PERSON","PRE","",OrdSetsId,UpdateUser)
			
			s:AddEntRet'="" ^wgy("AddEntRet")=AddEntRet
			s:AddEntRet'="" SQLCODE="-900"
		}
		
		i additemscodes'="" 
		{	
			s AddItemRet=""
			f i=1:1:$L(additemscodes,",")  q:AddItemRet'=""  d
			.s additemscode=$P(additemscodes,",",i) 
			.s OrdSetsId=$O(^ARCOS(0,"Code",$$ALPHAUP^SSUTIL4(additemscode),""))
			.i OrdSetsId'="" s AddItemRet=##class(web.DHCPE.PreItemList).IInsertItem(IADMID,"PERSON","PRE","",OrdSetsId,UpdateUser)
			.s OrderId=$O(^ARCIM(0,"Code",$$ALPHAUP^SSUTIL4(additemscode),""))
			.i OrderId'="" d
			..s OrderSub=$O(^ARCIM(0,"Code",$$ALPHAUP^SSUTIL4(additemscode),OrderId,""))
			..i OrderSub'="" s AddItemRet=##class(web.DHCPE.PreItemList).IInsertItem(IADMID,"PERSON","PRE",OrderId_"||"_OrderSub,"",UpdateUser)
			
			s:AddItemRet'="" ^wgy("AddItemRet")=AddItemRet
			s:AddItemRet'="" SQLCODE="-900"
		}
		
	
	}
	//把导入的名单的登记号临时记录在^TMPCRMCOMPANYID add by huangchuangqi 2019-1-9 start
	i ^TMPCRMCOMPANYID=""  s ^TMPCRMCOMPANYID=RealRegNo    
	else  s ^TMPCRMCOMPANYID=^TMPCRMCOMPANYID_"^"_RealRegNo
	//把导入的名单的登记号临时记录在^TMPCRMCOMPANYID add by huangchuangqi 2019-1-9 end
	q SQLCODE
]]></Implementation>
</Method>

<Method name="GetTMPCRMCOMPANYID">
<Description>
触发推送客户单位编码接口 add by huangchuangqi 2019-1-4 start
w ##class(web.DHCPE.ImportGInfo).GetTMPCRMCOMPANYID()</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Input:%String=""</FormalSpec>
<Implementation><![CDATA[
	set $zt="MsgErr"
	s Info= $g(^TMPCRMCOMPANYID)
	q:Info="" -1
	s len=$l(Info,"^")
	i len=1  d 
	.s RealRegNo=$g(^TMPCRMCOMPANYID) 
	.d ##class(web.DHCENS.STBLL.AccountAdditionalInfoUpdate.AccountAddInfoUpdate).CompanyIDCRM(RealRegNo)
	e  d
	.f i=1:1:len  d
	..s RealRegNo=$p(^TMPCRMCOMPANYID,"^",i)
	..d ##class(web.DHCENS.STBLL.AccountAdditionalInfoUpdate.AccountAddInfoUpdate).CompanyIDCRM(RealRegNo)
	
	q 0
MsgErr
	q -1
]]></Implementation>
</Method>

<Method name="UpdateHISPersonData">
<Description>
更新his里的病人信息
w ##class(web.DHCPE.ImportGInfo).UpdateHISPersonData("","^^王er^1^58426^1^^^18856857925^3452353425^^^高创（苏州)电子有限公司^^^^^22^^65020^7058^^^2^09027277^21^2")</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>RegNo,IBaseInfo</FormalSpec>
<Implementation><![CDATA[
	s ^wgy("UpdateHISPersonData")=RegNo_"$$"_IBaseInfo
	k PLIST
	s i=$L(IBaseInfo,"^")-4
	s CardNo=$p(IBaseInfo,"^",i+1)
	f j=1:1:i
	{
		s PLIST(j)=$P(IBaseInfo,"^",j)
	}
	s EmployeeNo=$p(IBaseInfo,"^",i+3)
	s HCADR=PLIST(i)
	k PLIST(i)
	s info=""
	i ""=$G(PLIST(5)) d
	.s Age=""
	e  d
	.s Age=##class(web.DHCLCNUREXCUTE).CalAge(PLIST(5),+$h)
	
	i ("0"'=Age)&&(""'=Age) d
	.s AgeDay=+$P($P(Age," ",3),"D",1)
	.s value=AgeDay
	e  d
	.s AgeDay=""
	.s value=""
	s info=info_""_value	// 1	AgeDay		paper_ageday
	
	i ("0"'=Age)&&(""'=Age) d
	.s AgeMoth=+$P($P(Age," ",2),"M",1)
	.s value=AgeMoth
	e  d
	.s AgeMoth=""
	.s value=""
	s info=info_"^"_value	// 2	AgeMoth		paper_agemth
	
	i ("0"'=Age)&&(""'=Age) d
	.s AgeYear=+$P($P(Age," ",1),"Y",1)
	.s value=AgeYear
	e  d
	.s AgeYear=""
	.s value=""
	s info=info_"^"_value	// 3	AgeYear		paper_ageyr
	
	s value=""
	s info=info_"^"_value	// 4	国家			paper_langprim_dr
	
	s value=$G(PLIST(5))
	s info=info_"^"_value	// 5	出生日期		paper_dob
	
	s value=$G(PLIST(3))
	s info=info_"^"_value	// 6	姓名			paper_name
	
	s value=$G(PLIST(4))
	s info=info_"^"_value	// 7	性别			paper_sex_dr
	
	s value="|||||||||||"_AgeYear_"|"_AgeMoth_"|"_AgeDay
	s info=info_"^"_value	// 8				paper_age
	
	s value=$G(PLIST(21))
	s info=info_"^"_value	// 9				paper_userupdate
	
	s value=""
	s info=info_"^"_value	// 10	国家			paper_country_dr
	
	s value=""
	s info=info_"^"_value	// 11	省			paper_ct_province_dr
	
	s value=""
	s info=info_"^"_value	// 12	城市			paper_citycode_dr
	
	s value=""
	s info=info_"^"_value	// 13	语言			paper_langprim_dr
	
	//s value=$G(PLIST(16))
	s value=""
	s info=info_"^"_value	// 14	民族			paper_nation_dr
	
	s value=""
	s info=info_"^"_value	// 15				
	
	s value=""
	s info=info_"^"_value	// 16	宗教			paper_religion_dr
	
	s value=$G(PLIST(18))
	s info=info_"^"_value	// 17	婚姻			paper_marital_dr
	
	s value=""
	s info=info_"^"_value	// 18	学历			paper_education_dr
	
	s value=$G(PLIST(6))
	s info=info_"^"_value	// 19	患者类型		paper_socialstatus_dr
	
	i ""=$G(PLIST(19)) d
	.s value=""
	e  d
	.s value=$p($G(^PAC("BLDT",PLIST(19))),"^",2)
	.
	s info=info_"^"_value	// 20	血型			paper_foreignid
	
	s value=$G(PLIST(14))
	s info=info_"^"_value	// 21	邮编			paper_zip_dr
	
	s value=$G(PLIST(9))
	s:value="" value=$G(PLIST(9))
	s info=info_"^"_value	// 22	电话			paper_telh
	
	s value=$G(PLIST(8))
	s info=info_"^"_value	// 23	单位电话		paper_telo
	
	s value=$G(PLIST(15))
	s info=info_"^"_value	// 24	地址			paper_secondphone
	
	s value=$G(PLIST(13))
	s info=info_"^"_value	// 25	工作单位		PAPER_NokAddress2
	
	s value=$G(PLIST(10))
	s info=info_"^"_value	// 26	身份证		paper_id
	
	s value=""
	s info=info_"^"_value	// 27	人名助记符	paper_name2		
	
	s value=""
	s info=info_"^"_value	// 28				PAPER_EmplType_DR
	
	s value=$P(IBaseInfo,"^",25)      
	s info=info_"^"_value	// 29				PAPER_EmployeeNo   工号
	s value=""
	s info=info_"^"_value	// 30				PAPER_HCP_DR
	s value=HCADR
	s info=info_"^"_value	// 31                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               				PAPER_CT_HCA_DR






















	s info=info_"^"_$P(IBaseInfo,"^",23)  //就诊卡号
	s $P(info,"^",33)=$P(IBaseInfo,"^",26)  //证件类型
	i (RegNo'="")
	{
		
		s rowid=$o(^PAPERi("PAPMI_PatNo",RegNo,""))
		//已存在
		i rowid'=""	d
		.s Oldcid=$p($G(^PAPER(rowid,"ALL")),"^",9)
		.i $p(info,"^",26)="" s $p(info,"^",26)=Oldcid
		.s OldHCADR=$p($g(^PAPER(rowid,"PER",4)),"^",3)
		.i $p(info,"^",31)="" s $p(info,"^",31)=OldHCADR
		.s OldHCPDR=$p($g(^PAPER(rowid,"PER",4)),"^",17)
		.i $p(info,"^",30)="" s $p(info,"^",30)=OldHCPDR
		.s OldEmployeeNo=$P($G(^PAPER(rowid,"EMP")),"^",5)
		.i OldEmployeeNo="" d
		..s $P(^PAPER(rowid,"EMP"),"^",5)=EmployeeNo
		..s:EmployeeNo'="" ^PAPERi("EmplNo",EmployeeNo,rowid)=""
		.s SQLCODE=0
		.//s SQLCODE=##class(web.DHCPE.PreIBIUpdate).upperson1(info,rowid)
		e  d
		.//不存在
		.d MDMHandler
		
	}
	else  //NoGen
	{
		d MDMHandler
		s RegNo=P5
		
	}
	i SQLCODE'=0 s SQLCODE=SQLCODE_"^"_RegNo_"^"_CardNo
	q SQLCODE
MDMHandler
	s ^wgy("MDMHandler")=info
	s MDMRet=##class(web.DHCPE.Platform.Handler).QueryMDM(info)
	s ^wgy("GMDMQueryRet")=MDMRet
	s MDMRetCode=$P(MDMRet,"^",1)
	i MDMRetCode<0  s SQLCODE=MDMRetCode q
	i MDMRetCode=0 d
	.//直接创建MDM
	.s MDMRegNo=##class(web.DHCPE.Platform.Handler).Main("",info,1)
	.i $P(MDMRegNo,"^",1)'=2 s SQLCODE=-200 q
	.e  d
	..s SQLCODE=##class(web.DHCPE.PreIBIUpdate).Insertperson(info,1,$G(PLIST(11)),$P(MDMRegNo,"^",2))
	..//s SQLCODE=##class(web.DHCPE.PreIBIUpdate).Insertperson(info,1,$G(PLIST(11)))
	i MDMRetCode=1 d
	.s MDMRegNo=$P($P(MDMRet,"^",2),$C(2),1)
	.s QuoteRet=##class(web.DHCPE.Platform.Handler).QuoteMDM(MDMRegNo)
	.i +QuoteRet'=0 s SQLCODE=-300 q
	.s SQLCODE=##class(web.DHCPE.PreIBIUpdate).Insertperson(info,1,$G(PLIST(11)),MDMRegNo)
	/*s SQLCODE=##class(web.DHCPE.PreIBIUpdate).Insertperson(info,1,$G(PLIST(11)))*/
	q
]]></Implementation>
</Method>

<Method name="GotoErr">
<Description>
导入数据时出错，退出使用</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Str</FormalSpec>
<Implementation><![CDATA[
	TROLLBACK
	d ..KillImportGlobal(JobID)
	//k ^DHCPEImportGInfo("ImportG",JobID)
	q Str_"^"
]]></Implementation>
</Method>

<Method name="KillImportGlobal">
<ClassMethod>1</ClassMethod>
<FormalSpec>job</FormalSpec>
<Implementation><![CDATA[
	k ^DHCPEImportGInfo("ImportG",job)
	k ^DHCPEImportGInfo("CheckCardId")      //add by zhouli 
	q 0
]]></Implementation>
</Method>

<Method name="CheckRegNo">
<Description>
检查登记号是否正确  Return  1:正确  0:错误
d ##class(web.DHCPE.ImportGInfo).CheckRegNo("00000000","000000111111111")</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>RegNo,CardNo:%String=""</FormalSpec>
<Implementation><![CDATA[

	s CardRelate=$G(^DHCPESetting("DHCPE","CardRelate"))
	
	s GenModel=##class(web.DHCPE.Public.Setting).GetPAPMINoGenModel()
	if GenModel="NoGen"
	{
		i CardRelate="Yes"
		{
			i (CardNo'="")&&(+RegNo'=0)
			{
				s CurRegNo=##class(web.DHCPE.PreIBIUpdate).GetRelate(CardNo, "C")
				s CurRegNo=##class(web.DHCPE.DHCPECommon).RegNoMask(CurRegNo)
				q:(RegNo'=CurRegNo) "卡号与登记号不一致"
				q 1
			}
			//elseif (CardNo="")&&(+RegNo=0)
			//{
			//	q "卡号与登记号必须填一个"
			//}
			elseif (CardNo'="")
			{
				s CurRegNo=##class(web.DHCPE.PreIBIUpdate).GetRelate(CardNo, "C")
				i CurRegNo'=""
				{   i RegNo'="0000000000" 
				 {
					s PAPID=$o(^PAPERi("PAPMI_PatNo",RegNo,""))
					s oldName=$P(^PAPER(PAPID,"ALL"),"^",1)
					i oldName'=Name q "卡号已经使用,并且与原姓名不一致"_CardNo
				}
					s RegNo=CurRegNo
				}
				
				q 1
			}
			elseif (+RegNo'=0)&&(CardNo'="")
			{
				s CurCardNo=##class(web.DHCPE.PreIBIUpdate).GetRelate(RegNo, "R")
				i CurCardNo'="" s CardNo=CurCardNo
				i CurCardNo="" q "登记号对应的卡号不存在"
				q 1	
			}
		}
		q:+RegNo=0 1
		s PAPID=$o(^PAPERi("PAPMI_PatNo",RegNo,""))
		q:PAPID'="" 1
		q 0
	}
	if GenModel="FreeCreate"
	{
		q:+RegNo=0 0
		q 1
	}
	//Gen
	s PAPID=$o(^PAPERi("PAPMI_PatNo",RegNo,""))
	i PAPID="" q 0
	/*i $G(^DHCPESetting("DHCPE","HospitalCode"))="FX"
	{
		s Str=$E(RegNo,8,8)
		q:Str="4" 0
		s Str=$E(RegNo,7,7)
		q:Str="4" 0
		s Str=$E(RegNo,6,6)
		q:Str="4" 0
	}*/
	q 1
]]></Implementation>
</Method>

<Method name="GetRegNoByIDCard">
<ClassMethod>1</ClassMethod>
<FormalSpec>IDCard</FormalSpec>
<Implementation><![CDATA[
	n (IDCard)
	q:IDCard="" ""
	s HadFlag=0
	s AllRegNo=""
	s IDCard=$ZCVT(IDCard,"U")
	s PatientID=""
	f  s PatientID=$O(^PAPERi("DVA",IDCard,PatientID),-1) q:PatientID=""  d
	.s ActiveFlag=$P(^PAPER(PatientID,"PAT",1),"^",6)
	.q:ActiveFlag="N"
	.s RegNo=$P(^PAPER(PatientID,"PAT",1),"^",1)
	.i AllRegNo="" s AllRegNo=RegNo
	.e  s AllRegNo=AllRegNo_"^"_RegNo
	q:AllRegNo'="" AllRegNo
	s ChangeIDCard=""
	i $L(IDCard)=15 d
	.s ChangeIDCard=..ID15to18(IDCard)
	e  i $L(IDCard)=18 d
	.s ChangeIDCard=..ID18to15(IDCard)
	q:ChangeIDCard="" AllRegNo
	s PatientID=""
	f  s PatientID=$O(^PAPERi("DVA",ChangeIDCard,PatientID),-1) q:PatientID=""  d
	.s ActiveFlag=$P(^PAPER(PatientID,"PAT",1),"^",6)
	.q:ActiveFlag="N"
	.s RegNo=$P(^PAPER(PatientID,"PAT",1),"^",1)
	.i AllRegNo="" s AllRegNo=RegNo
	.e  s AllRegNo=AllRegNo_"^"_RegNo
	q AllRegNo
]]></Implementation>
</Method>

<Method name="ID15to18">
<ClassMethod>1</ClassMethod>
<FormalSpec>IDCardNo15:%String=""</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[

	if $length(IDCardNo15)'=15 quit IDCardNo15
	set IDCardNo17=$extract(IDCardNo15,1,6)_"19"_$extract(IDCardNo15,7,15)

	set W(1)=1,W(2)=2,W(3)=4,W(4)=8,W(5)=5,W(6)=10,W(7)=9,W(8)=7,W(9)=3,W(10)=6
	set W(11)=1,W(12)=2,W(13)=4,W(14)=8,W(15)=5,W(16)=10,W(17)=9,W(18)=7
	set Y(0)="1",Y(1)="0",Y(2)="X",Y(3)="9",Y(4)="8",Y(5)="7",Y(6)="6",Y(7)="5",Y(8)="4",Y(9)="3",Y(10)="2"

	set snum=0
	for i=18:-1:2
	{
		set snum=snum+($extract(IDCardNo17,19-i,19-i)*W(i))
	}

	set ynum=snum#11

	set IDCardNo18=IDCardNo17_Y(ynum)
	quit IDCardNo18
]]></Implementation>
</Method>

<Method name="ID18to15">
<Description>
身份证号18位转15位</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>IDCardNo18:%String=""</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	if $length(IDCardNo18)'=18 quit IDCardNo18
	set IDCardNo15=$extract(IDCardNo18,1,6)_$extract(IDCardNo18,9,17)

	quit IDCardNo15
]]></Implementation>
</Method>

<UDLText name="T">
<Content><![CDATA[
// w ##class(web.DHCPE.ImportGInfo).CheckName("","黄")

]]></Content>
</UDLText>

<Method name="CheckRegNoByDobName">
<Description>
根据姓名生日判断是否已经存在登记号</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>Dob,Name,RegNo,curSex,Type:%String="Import"</FormalSpec>
<Implementation><![CDATA[
   
	new Flag,bFlag,rRegNo,PAPMIId
	s PAPMIId=0
	s bFlag=0
	s Flag=0
	s rRegNo=""
	//i CardNoIndex="" q bFlag
	f  s PAPMIId=$o(^PAPERi("DOB",Dob,Name,PAPMIId)) q:(PAPMIId="")  d
	.s curRegNo=$P(^PAPER(PAPMIId,"PAT",1),"^",1)
	.s PatSexID=$P(^PAPER(PAPMIId,"ALL"),"^",7)
	.s ActiveFlag=$P(^PAPER(PAPMIId,"PAT",1),"^",6)
	.q:ActiveFlag="N"
	.Q:(curSex'="")&&(curSex'=PatSexID)
	.i +RegNo=0 d
	..s bFlag=1
	..s rRegNo=rRegNo_"^"_curRegNo
	.e  d
	..i curRegNo=RegNo d
	...i Type="Import" s Flag=1
	...
	..e  d
	...s bFlag=1
	...s rRegNo=rRegNo_"^"_curRegNo
	i Flag=1 q 0
	i bFlag=1 q $p(rRegNo,"^",2,$l(rRegNo,"^"))
	q 0
]]></Implementation>
</Method>

<UDLText name="T">
<Content><![CDATA[
// w ##class(web.DHCPE.ImportGInfo).CheckName(1,"黄")

]]></Content>
</UDLText>

<Method name="CheckName">
<ClassMethod>1</ClassMethod>
<FormalSpec>RegNo,OldName</FormalSpec>
<Implementation><![CDATA[
	n (RegNo,OldName)
	s RegNo=##class(web.DHCPE.DHCPECommon).RegNoMask(RegNo)
	q:+RegNo=0 0
	s PAPID=$o(^PAPERi("PAPMI_PatNo",RegNo,""))
	q:PAPID="" 0
	s Name=$p($G(^PAPER(PAPID,"ALL")),"^",1)
	q:(Name'=OldName)&&(Name'="未用") 1
	q 0
]]></Implementation>
</Method>

<Method name="CheckSex">
<ClassMethod>1</ClassMethod>
<FormalSpec>RegNo,OldSex</FormalSpec>
<Implementation><![CDATA[
	n (RegNo,OldSex)
	s RegNo=##class(web.DHCPE.DHCPECommon).RegNoMask(RegNo)
	q:+RegNo=0 0
	s PAPID=$o(^PAPERi("PAPMI_PatNo",RegNo,""))
	q:PAPID="" 0
	s CurSex=$p($G(^PAPER(PAPID,"ALL")),"^",7)
	q:(CurSex'=OldSex) 1
	q 0
]]></Implementation>
</Method>

<UDLText name="T">
<Content><![CDATA[
// w ##class(web.DHCPE.ImportGInfo).GetTIDByInfo("","46495",2,2,4)

]]></Content>
</UDLText>

<Method name="GetTIDByInfo">
<ClassMethod>1</ClassMethod>
<FormalSpec>TName,Birth,Sex,Married,GID</FormalSpec>
<Implementation><![CDATA[
    s ^yk("import")=TName_"^"_Birth_"^"_Married_"^"_GID
    s ^tempwml("GetTIDByInfo")=$lb(TName, Birth, Sex, Married, GID)
	s tid=""
	s tsub=0
	f  s tsub=$O(^DHCPEPreGADM(GID,"Team",tsub)) q:(tsub="")||(tid'="")  d
	.s TCurData=$G(^DHCPEPreGADM(GID,"Team",tsub))
	.s ret=""
	.i TName'="" d
	..s curName=$p(TCurData,"^",1)
	..i curName=TName d
	...s tid=GID_"||"_tsub
	.e  d
	..s PGTSex = $p(TCurData,"^",12)
	..i '((""=PGTSex)||("N"=PGTSex)||("No"=PGTSex)) d
	...//	PIBI_Sex_DR	性别
	...s PIBISexDR=Sex
	...i (""=PIBISexDR) s ret="No Valid Sex"
	...//CT_Sex	CTSEX_Desc
	...s PIBISexDRName=$p($G(^CT("SEX",PIBISexDR)),"^",2)
	...i ((("Female"=PGTSex)||("F"=PGTSex))&(PIBISexDRName'["女")) s ret="Sex Err"
	...i ((("Male"=PGTSex)||("M"=PGTSex))&(PIBISexDRName'["男")) s ret="Sex Err "
	..Q:(""'=ret)	
	
	..// 3 PGT_UpperLimit	年龄上限
	..s PGTUpperLimit = $p(TCurData,"^",13)
	..// 4 PGT_LowerLimit	年龄下限
	..s PGTLowerLimit = $p(TCurData,"^",14)
	..//	PIBI_DOB	生日
	..s PIBIDOB=Birth
	..i (""'=PIBIDOB) d
 	...s PIBIDOB=##class(web.DHCLCNUREXCUTE).CalAge(PIBIDOB,+$h)
 	...s PIBIDOB=+$P(PIBIDOB,"Y",1)
	..i (""'=PGTLowerLimit)&(""'=PIBIDOB)&(+PIBIDOB<+PGTLowerLimit) s ret="LowerLimit Err"
	..i (""'=PGTUpperLimit)&(""'=PIBIDOB)&(+PIBIDOB>+PGTUpperLimit) s ret="UpperLimit Err"
	..Q:(""'=ret)
	
	..// 5 PGT_Married	婚姻状况
	..s PGTMarried = $p(TCurData,"^",15)
	..i '((""=PGTMarried)||("N"=PGTMarried)||("No"=PGTMarried)) d
	...//	PIBI_Married	婚姻状况
	...s PIBIMarriedDR=Married
	...i ""=PIBIMarriedDR s ret="No Valid Married "
	...//CT_Marital	CTMAR_Desc
	...s PIBIMarriedDRName=$p($G(^CT("MAR",PIBIMarriedDR)),"^",2)
	...i ((("Unmarried"=PGTMarried)||("UM"=PGTMarried))&(PIBIMarriedDRName'["未婚")) s ret="Married Err"
	...i ((("Married"=PGTMarried)||("M"=PGTMarried))&(PIBIMarriedDRName'["已婚")) s ret="Married Err"
	..Q:(""'=ret)
	..s tid=GID_"||"_tsub
	q tid
]]></Implementation>
</Method>

<Method name="GetTeamInforDate">
<Description>
获取分组的截止日期 add by wangminglong 2019-3-14 start
w ##class(web.DHCPE.ImportGInfo).GetTeamInforDate("方法","1981-12-18","男","已婚","470")</Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>TName,Birth,Sex,Married,GID</FormalSpec>
<Implementation><![CDATA[
	s ^tempwml("GetTeamInforDate")=$lb(TName,Birth,Sex,Married,GID)
	s ^DHCPEPreDate("flag")=1     //该客户不填预约时间的标记
	s Birth=$ZDH(Birth,3)
	s Married=..GetMarried(Married)
	s Sex=..GetSexId(Sex)
	s TeamId=..GetTIDByInfo(TName,Birth,Sex,Married,GID)
	s TDate=""
	i TeamId'="" d
	.s TInfo="^^^"_$G(^DHCPEPreGADM(+TeamId,"Team",$p(TeamId,"||",2))) //增加^^^是为了和原来的统一
	.s TDate=$p(TInfo,"^",6)
	.s TDate=$zd(TDate,3)
	q TDate
]]></Implementation>
</Method>

<UDLText name="T">
<Content><![CDATA[
// w ##class(web.DHCPE.ImportGInfo).CheckRegNoInGroupByName("体检测试4","10","23","","3092","东华公司")

]]></Content>
</UDLText>

<Method name="CheckRegNoInGroupByName">
<ClassMethod>1</ClassMethod>
<FormalSpec>Name,Sex,Age,Type:%String="Import",Job,GDesc</FormalSpec>
<Implementation><![CDATA[
	n (Name, Sex, Age, Type,Job, GDesc)
	S ExistFlag=0
    s PGADMRowIdStr=""
	s PGBIRowId=0
	f  s PGBIRowId=$o(^DHCPEPreGBI(0,"Desc",GDesc,PGBIRowId))  q:PGBIRowId=""  d
	.s PGADMRowId=0
	.f  s PGADMRowId=$o(^DHCPEPreGADM(0,"PGBI",PGBIRowId,PGADMRowId))  q:PGADMRowId=""  d
	..i PGADMRowIdStr=""   s PGADMRowIdStr=PGADMRowId
	..else  s PGADMRowIdStr=PGADMRowIdStr_"^"_PGADMRowId

	s PIBIRowId=0,RegNoStr=""
    f  s PIBIRowId=$o(^DHCPEPreIBI(0,"Name",Name,PIBIRowId))  q:PIBIRowId=""  d
    .s RegNo=$p(^DHCPEPreIBI(PIBIRowId),"^",1)
    .s PatSex=$p(^DHCPEPreIBI(PIBIRowId),"^",3)
    .s PatBOD=$p(^DHCPEPreIBI(PIBIRowId),"^",4)
    .s PatAge=##class(web.DHCLCNUREXCUTE).CalAge(PatBOD,+$h)
	.s PatAge=$P(PatAge,"Y",1)
	.Q:(Sex'="")&&(Sex'=PatSex)
	.Q:(Age'="")&&(Age'=PatAge)
	.s IADMRowId=0
	.f  s IADMRowId=$o(^DHCPEPreIADM(0,"PIBI",PIBIRowId,IADMRowId))  q:IADMRowId=""  d
	..s PGADM=$P(^DHCPEPreIADM(IADMRowId),"^",2)
	..q:PGADM=""
	..s PGBID=$p(^DHCPEPreGADM(PGADM),"^",1)
	..q:PGBID=""
	..S PGDesc=$p(^DHCPEPreGBI(PGBID),"^",2)
	..q:GDesc'=PGDesc
	..S ExistFlag=1
	..i RegNoStr=""  s RegNoStr=RegNo
	..else  d
	...i ("^"_RegNoStr_"^")'[("^"_RegNo_"^") s RegNoStr=RegNoStr_"^"_RegNo
 i ExistFlag=0 q 0
 i ExistFlag=1  q RegNoStr
]]></Implementation>
</Method>

<Method name="CheckBodAndAgeByRegNo">
<ClassMethod>1</ClassMethod>
<FormalSpec>PatRegNo</FormalSpec>
<Implementation><![CDATA[
	s Bod="",Age=""
	s PatRegNo=##class(web.DHCPE.DHCPECommon).RegNoMask(PatRegNo)
	q:+PatRegNo=0 "^"
	s PAPID=$o(^PAPERi("PAPMI_PatNo",PatRegNo,""))
	q:PAPID="" "^"
	s Bod=$p($G(^PAPER(PAPID,"ALL")),"^",6)
    s Age=##class(web.DHCLCNUREXCUTE).CalAge(Bod,+$h)
	s Age=$P(Age,"Y",1)
	i Bod'=""  s Bod=$ZD(Bod,3)
	q Bod_"^"_Age
]]></Implementation>
</Method>
</Class>
</Export>
